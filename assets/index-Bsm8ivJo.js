var Re=Object.defineProperty;var je=(h,e,t)=>e in h?Re(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var n=(h,e,t)=>je(h,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();class Kt extends Array{indexAt(e,t){return this.findIndex(s=>s[e]===t)}type(e){return new Kt(...this.filter(t=>t.type===e))}success(e){return this.splice(this.findIndex(t=>t.id===e),1)}}const He="client",Ye="0.2.8",We="module",$e={dev:"cross-env NODE_ENV=development vite",build:"rm -rf dist/ && tsc && vite build",preview:"vite preview","test:view":"npx vite preview --outDir html",test:"vitest",lint:"eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",exam:"bash ./scripts/exam",deploy:'touch dist/.nojekyll && cd dist && git init && git add -A && git commit -m "gh-pages" && git push https://github.com/kkn1125/game-2d-boilerplate.git master:gh-pages -f'},Fe={"@types/node":"^20.12.11","@vitest/browser":"^1.6.0","@vitest/coverage-istanbul":"^1.6.0","@vitest/coverage-v8":"^1.6.0","@vitest/ui":"^1.6.0","cross-env":"^7.0.3",dotenv:"^16.4.5",eslint:"^8.57.0","eslint-config-airbnb":"^19.0.4",globals:"^15.2.0",jsdom:"^24.0.0",sass:"^1.77.1","ts-node":"^10.9.2","tsconfig-paths":"^4.2.0",typescript:"^5.4.5","typescript-eslint":"^7.8.0",vite:"^5.2.11","vite-node":"^1.6.0","vite-plugin-pwa":"^0.20.0","vite-tsconfig-paths":"^4.3.2",vitest:"^1.6.0",webdriverio:"^8.36.1"},Xe={"@types/uuid":"^9.0.8",axios:"^1.6.8",chalk:"5.3.0",client:"file:","react-router-dom":"^6.23.1",uuid:"^9.0.1"},Qe={name:He,private:!0,version:Ye,type:We,scripts:$e,devDependencies:Fe,dependencies:Xe},$=document.querySelector("#app"),gt="/game-2d-boilerplate/";var D=(h=>(h.None="none",h.Question="question",h.Walking="walking",h.Hold="hold",h.Dead="dead",h.ReSpawning="respawning",h))(D||{});const Dt=[],U=[],H=[],vt=new Kt;window.globalQuestionQueue=U;window.globalDelayQueue=H;window.globalEffectQueue=vt;const L={NONE:"none",BASE_COUNTRY:"base-country",BASE_FIELD_1:"base-field-1",MAIN_HOUSE:"main-house",HOUSE:"house-1",DESTROYED_COUNTRY:"destroyed-country",DESTROYED_HOUSE1:"destroyed-house-1"},Je={0:{name:"grass",type:"way"},1:{name:"road",type:"way"},2:{name:"water",type:"block"},3:{name:"tree",type:"block"},4:{name:"bush",type:"block"},5:{name:"tree2",type:"block"},6:{name:"box",type:"block"},a:{name:"block:grass",type:"block"}},b=({prod:h,or:e})=>h,g={defaultSpawn:L.BASE_COUNTRY,mode:"single",logger:b({prod:!1,or:!0}),minimap:{display:b({prod:!0,or:!0}),scale:.2},helper:{map:{grid:b({prod:!1,or:!1})},item:{sign:b({prod:!1,or:!0}),boundary:{around:b({prod:!0,or:!0})}},npc:{sign:b({prod:!0,or:!0}),boundary:{around:b({prod:!1,or:!0})}},player:{boundary:{attack:b({prod:!1,or:!0}),around:b({prod:!1,or:!1})}},monster:{sign:b({prod:!0,or:!0}),boundary:{attack:b({prod:!1,or:!1}),around:b({prod:!1,or:!0})}},shootObject:{sign:b({prod:!1,or:!1}),boundary:{attack:b({prod:!1,or:!1}),around:b({prod:!1,or:!1})}},portal:{sign:!0,boundary:{around:b({prod:!1,or:!1})}},building:{sign:b({prod:!1,or:!1}),boundary:{around:b({prod:!1,or:!1})}}},display:{gametime:b({prod:!1,or:!1}),money:b({prod:!1,or:!1}),item:{name:b({prod:!0,or:!0})},monster:{name:b({prod:!0,or:!0}),health:b({prod:!0,or:!0}),mana:b({prod:!1,or:!1})},shootObject:{name:b({prod:!1,or:!1}),health:b({prod:!1,or:!1}),mana:b({prod:!1,or:!1})},player:{name:b({prod:!0,or:!0}),health:b({prod:!0,or:!0}),mana:b({prod:!0,or:!0}),others:{name:b({prod:!0,or:!0}),health:b({prod:!0,or:!0}),mana:b({prod:!0,or:!0})}},npc:{name:b({prod:!0,or:!0}),health:b({prod:!1,or:!1}),mana:b({prod:!1,or:!1}),level:b({prod:!1,or:!1})},portal:{name:b({prod:!0,or:!0})},building:{name:b({prod:!0,or:!0})}}};let d={SCALE:1,VIEW:{x:0,y:0}};d=new Proxy(d,{set(h,e,t,s){return Reflect.set(h,e,t,s)},get(h,e,t){return Reflect.get(h,e,t)}});const oe=1.2,ot={VELOCITY:{UNIT:{INCREASE:oe/3*d.SCALE,LIMIT:oe*2*d.SCALE,BASE:0,JUMP:1,ATTACK:1},MONSTER:{INCREASE:.01*d.SCALE,LIMIT:.5*d.SCALE,BASE:0,JUMP:1,ATTACK:3}}},x={FIELD:52*d.SCALE,ITEM:{X:24*d.SCALE,Y:24*d.SCALE},UNIT:{X:32*d.SCALE,Y:48*d.SCALE},PORTAL:{X:32*d.SCALE,Y:48*d.SCALE},MONSTER:{X:32*d.SCALE,Y:32*d.SCALE}},Q={DEFAULT:{BUILDING:{AROUND_DIST:80*d.SCALE},PORTAL:{AROUND_DIST:50*d.SCALE},ITEM:{ATTACK_DIST:20*d.SCALE,AROUND_DIST:10*d.SCALE},UNIT:{HEALTH:100,MANA:30,AROUND_DIST:50*d.SCALE,ATTACK_DIST:20*d.SCALE},NPC:{HEALTH:1/0,MANA:1/0},MONSTER:{MONEY:10,HEALTH:100,MANA:30,AROUND_DIST:50*d.SCALE,ATTACK_DIST:20*d.SCALE}}};let Bt;const Ge=new Uint8Array(16);function _e(){if(!Bt&&(Bt=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Bt))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Bt(Ge)}const V=[];for(let h=0;h<256;++h)V.push((h+256).toString(16).slice(1));function Ve(h,e=0){return V[h[e+0]]+V[h[e+1]]+V[h[e+2]]+V[h[e+3]]+"-"+V[h[e+4]]+V[h[e+5]]+"-"+V[h[e+6]]+V[h[e+7]]+"-"+V[h[e+8]]+V[h[e+9]]+"-"+V[h[e+10]]+V[h[e+11]]+V[h[e+12]]+V[h[e+13]]+V[h[e+14]]+V[h[e+15]]}const Ke=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),ne={randomUUID:Ke};function ae(h,e,t){if(ne.randomUUID&&!e&&!h)return ne.randomUUID();h=h||{};const s=h.random||(h.rng||_e)();return s[6]=s[6]&15|64,s[8]=s[8]&63|128,Ve(s)}const me=(h,e)=>e.replace(/YYYY|MM|dd|HH|mm|ss|SSS|AP/g,t=>{const s=new Date(h),i=!!e.match(/AP/),o=s.getFullYear(),a=s.getMonth()+1,r=s.getDate(),l=s.getHours(),y=i&&l>12?l-12:l,c=s.getMinutes(),p=s.getSeconds(),u=s.getMilliseconds();switch(t){case"YYYY":return o.toString().padStart(4,"0");case"MM":return a.toString().padStart(2,"0");case"dd":return r.toString().padStart(2,"0");case"HH":return y.toString().padStart(2,"0");case"mm":return c.toString().padStart(2,"0");case"ss":return p.toString().padStart(2,"0");case"SSS":return u.toString().padStart(3,"0");case"AP":return l>12?"PM":"AM";default:return t}}),qt=({x:h,y:e})=>{const t=innerWidth/2,s=innerHeight/2,i=h*x.FIELD/2,o=e*x.FIELD/2,a=d.VIEW.x,r=d.VIEW.y;return[Math.floor(t-i-a),Math.floor(s-o-r)]},rt=({x:h,y:e})=>{const t=innerWidth/2,s=innerHeight/2,i=d.VIEW.x,o=d.VIEW.y;return[Math.floor(t-h/2-i),Math.floor(s-e/2-o)]},ft=(h,e)=>{const t=Math.floor(h*x.FIELD),s=Math.floor(e*x.FIELD);return{x:t,y:s}},Ze=h=>h==null,ht=h=>Ze(h)?ae():h+"-"+ae(),ts=(h,e)=>`${gt}images/${e}/${h}`,O=(h,e)=>{const t=new Image;return t.src=ts(h,e),t},re=h=>h.split(/[:\s_-]+/g).map(e=>h.at(0).toUpperCase()+h.slice(1).toLocaleLowerCase()).join(""),Lt=h=>{const e=Dt.find(t=>t===h);Object.assign(e,{isLoaded:!0})},es={Basic:`${gt}profiles/portal/basic.png`},ge={Normal:"#222222",A:"#183774",B:"#247418",C:"#b0be40",D:"#c65023",E:"#c62323",F:"#be23c6",G:"#5023c6",Portal:"#0000ff"},ss={None:"#eeeeee",House:"#343434",White:"#ffffff",Grey:"#555555",Dark:"#000000",SkyBule:"#446ebd",Success:"#2c6e3c",Attacking:"#bc2929",Attacked:"#6e2c2c",Warning:"#c9c224",Info:"#244dc9",Question:"#c924bc",Event:"#c9245c",Near:"#329751",Attackable:"#b95555",Health:"#e33a3a",Mana:"#3a73e3"},f={Name:ge,Sign:ss},is={Piece:{Bullet:O("bullet.png","object/piece")},Item:{Sword:O("sword.png","object/item"),Gun:O("gun.png","object/item"),Banana:O("banana.png","object/item")},None:O("none.png","object")},os={Bush:O("bush.png","fields"),"Block:Grass":O("grass-1.png","fields"),Grass:O("grass-1.png","fields"),Road:O("road.png","fields"),Water:O("water.png","fields"),Tree:O("tree.png","fields"),Tileset1:O("tileset.png","tileset"),Tileset2:O("tileset2.png","tileset"),Object:O("object.png","tileset")},ns={Player:{Back:O("student01-back.png","player"),Front:O("student01-front.png","player"),Left:O("student01-left.png","player"),Right:O("student01-right.png","player")},Monster:{SlimeFront:O("slime-front.png","monster"),MonkeyFront:O("monkey-front.png","monster")}},as={Basic:O("object.png","tileset"),Opacity:O("object-opacity.png","tileset")},rs={Basic:O("basic.png","portal")},S={Sprites:os,Character:ns,Object:is,Building:as,Portal:rs},Xt=10,he=(h=0)=>e=>`\x1B[${e+h}m`,le=(h=0)=>e=>`\x1B[${38+h};5;${e}m`,ce=(h=0)=>(e,t,s)=>`\x1B[${38+h};2;${e};${t};${s}m`,q={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};Object.keys(q.modifier);const hs=Object.keys(q.color),ls=Object.keys(q.bgColor);[...hs,...ls];function cs(){const h=new Map;for(const[e,t]of Object.entries(q)){for(const[s,i]of Object.entries(t))q[s]={open:`\x1B[${i[0]}m`,close:`\x1B[${i[1]}m`},t[s]=q[s],h.set(i[0],i[1]);Object.defineProperty(q,e,{value:t,enumerable:!1})}return Object.defineProperty(q,"codes",{value:h,enumerable:!1}),q.color.close="\x1B[39m",q.bgColor.close="\x1B[49m",q.color.ansi=he(),q.color.ansi256=le(),q.color.ansi16m=ce(),q.bgColor.ansi=he(Xt),q.bgColor.ansi256=le(Xt),q.bgColor.ansi16m=ce(Xt),Object.defineProperties(q,{rgbToAnsi256:{value(e,t,s){return e===t&&t===s?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(s/255*5)},enumerable:!1},hexToRgb:{value(e){const t=/[a-f\d]{6}|[a-f\d]{3}/i.exec(e.toString(16));if(!t)return[0,0,0];let[s]=t;s.length===3&&(s=[...s].map(o=>o+o).join(""));const i=Number.parseInt(s,16);return[i>>16&255,i>>8&255,i&255]},enumerable:!1},hexToAnsi256:{value:e=>q.rgbToAnsi256(...q.hexToRgb(e)),enumerable:!1},ansi256ToAnsi:{value(e){if(e<8)return 30+e;if(e<16)return 90+(e-8);let t,s,i;if(e>=232)t=((e-232)*10+8)/255,s=t,i=t;else{e-=16;const r=e%36;t=Math.floor(e/36)/5,s=Math.floor(r/6)/5,i=r%6/5}const o=Math.max(t,s,i)*2;if(o===0)return 30;let a=30+(Math.round(i)<<2|Math.round(s)<<1|Math.round(t));return o===2&&(a+=60),a},enumerable:!1},rgbToAnsi:{value:(e,t,s)=>q.ansi256ToAnsi(q.rgbToAnsi256(e,t,s)),enumerable:!1},hexToAnsi:{value:e=>q.ansi256ToAnsi(q.hexToAnsi256(e)),enumerable:!1}}),q}const lt=cs(),Ot=(()=>{if(navigator.userAgentData){const h=navigator.userAgentData.brands.find(({brand:e})=>e==="Chromium");if(h&&h.version>93)return 3}return/\b(Chrome|Chromium)\//.test(navigator.userAgent)?1:0})(),de=Ot!==0&&{level:Ot,hasBasic:!0,has256:Ot>=2,has16m:Ot>=3},ds={stdout:de,stderr:de};function ps(h,e,t){let s=h.indexOf(e);if(s===-1)return h;const i=e.length;let o=0,a="";do a+=h.slice(o,s)+e+t,o=s+i,s=h.indexOf(e,o);while(s!==-1);return a+=h.slice(o),a}function us(h,e,t,s){let i=0,o="";do{const a=h[s-1]==="\r";o+=h.slice(i,a?s-1:s)+e+(a?`\r
`:`
`)+t,i=s+1,s=h.indexOf(`
`,i)}while(s!==-1);return o+=h.slice(i),o}const{stdout:pe,stderr:ue}=ds,Qt=Symbol("GENERATOR"),At=Symbol("STYLER"),Nt=Symbol("IS_EMPTY"),fe=["ansi","ansi","ansi256","ansi16m"],bt=Object.create(null),fs=(h,e={})=>{if(e.level&&!(Number.isInteger(e.level)&&e.level>=0&&e.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");const t=pe?pe.level:0;h.level=e.level===void 0?t:e.level},ys=h=>{const e=(...t)=>t.join(" ");return fs(e,h),Object.setPrototypeOf(e,Pt.prototype),e};function Pt(h){return ys(h)}Object.setPrototypeOf(Pt.prototype,Function.prototype);for(const[h,e]of Object.entries(lt))bt[h]={get(){const t=jt(this,Gt(e.open,e.close,this[At]),this[Nt]);return Object.defineProperty(this,h,{value:t}),t}};bt.visible={get(){const h=jt(this,this[At],!0);return Object.defineProperty(this,"visible",{value:h}),h}};const Jt=(h,e,t,...s)=>h==="rgb"?e==="ansi16m"?lt[t].ansi16m(...s):e==="ansi256"?lt[t].ansi256(lt.rgbToAnsi256(...s)):lt[t].ansi(lt.rgbToAnsi(...s)):h==="hex"?Jt("rgb",e,t,...lt.hexToRgb(...s)):lt[t][h](...s),ms=["rgb","hex","ansi256"];for(const h of ms){bt[h]={get(){const{level:t}=this;return function(...s){const i=Gt(Jt(h,fe[t],"color",...s),lt.color.close,this[At]);return jt(this,i,this[Nt])}}};const e="bg"+h[0].toUpperCase()+h.slice(1);bt[e]={get(){const{level:t}=this;return function(...s){const i=Gt(Jt(h,fe[t],"bgColor",...s),lt.bgColor.close,this[At]);return jt(this,i,this[Nt])}}}}const gs=Object.defineProperties(()=>{},{...bt,level:{enumerable:!0,get(){return this[Qt].level},set(h){this[Qt].level=h}}}),Gt=(h,e,t)=>{let s,i;return t===void 0?(s=h,i=e):(s=t.openAll+h,i=e+t.closeAll),{open:h,close:e,openAll:s,closeAll:i,parent:t}},jt=(h,e,t)=>{const s=(...i)=>Ss(s,i.length===1?""+i[0]:i.join(" "));return Object.setPrototypeOf(s,gs),s[Qt]=h,s[At]=e,s[Nt]=t,s},Ss=(h,e)=>{if(h.level<=0||!e)return h[Nt]?"":e;let t=h[At];if(t===void 0)return e;const{openAll:s,closeAll:i}=t;if(e.includes("\x1B"))for(;t!==void 0;)e=ps(e,t.close,t.open),t=t.parent;const o=e.indexOf(`
`);return o!==-1&&(e=us(e,i,s,o)),s+e+i};Object.defineProperties(Pt.prototype,bt);const zt=Pt();Pt({level:ue?ue.level:0});class nt{constructor(e){n(this,"context");n(this,"colorSet",{log:"#88e986",debug:"#bd81d1",error:"#e96767",info:"#67a2e9",group:"#67a2e9"});n(this,"signSet",{log:"📝",debug:"🐛",error:"🚨",info:"🌟",group:"🪵"});n(this,"log");n(this,"debug");n(this,"error");n(this,"info");n(this,"group");let t="system";const s=typeof e=="string",i=e instanceof Object,o=i&&"name"in e&&typeof e.name=="string"&&e.name.length>0;i&&(t=e.constructor.name),o&&(t+=":"+e.name),s&&(t=e),this.context=t,this.initialize()}setContext(e){this.context=e,this.initialize()}get fixed(){const e=this.log,t=this.debug,s=this.error,i=this.info;return{get loaded(){return t.bind(this,"로드 됨")},get exception(){return s.bind(this,"예외: 확인 필요")},get called(){return i.bind(this,"호출 됨")},get check(){return e.bind(this,"확인 됨")}}}convertLogLevel(e){const t=this.signSet,s=this.colorSet,i=this.context;Object.defineProperty(this,e,{get(){if(!g.logger)return()=>{};const a=new Date;return console.log.bind(this,zt.call(zt,`${t[e]}`,zt.gray(me(a,"HH:mm:ss.SSS")),zt.bold.hex(s[e])(`[${e.toUpperCase()}]`),zt.white.redBright(`[${i}]`)))}})}initialize(){!g.logger?(this.log=()=>{},this.debug=()=>{},this.error=()=>{},this.info=()=>{},this.group=()=>{}):(this.convertLogLevel("log"),this.convertLogLevel("info"),this.convertLogLevel("debug"),this.convertLogLevel("error"),this.convertLogLevel("group"))}}class Se{constructor(e){n(this,"logger");n(this,"isProcessed");n(this,"events",[]);n(this,"id");n(this,"name");n(this,"startTime",0);n(this,"before",0);n(this,"duration",3);n(this,"effect");n(this,"canvas");n(this,"ctx");n(this,"fadeInDuration",1);n(this,"fadeOutDuration",1);n(this,"renderFx");this.id=ht("ex"),this.name=e,this.logger=new nt(this),this.logger.fixed.loaded()}onDestroy(e){this.events.push(e)}setupCanvas(){const e=document.createElement("canvas"),t=e.getContext("2d");this.canvas=e,this.canvas.id="effect-"+this.id,this.ctx=t,$.append(this.canvas),this.handleResizeOnce(),window.addEventListener("resize",this.handleResizeOnce.bind(this))}handleResizeOnce(){this.canvas.width=innerWidth,this.canvas.height=innerHeight}draw(e){var a,r,l;if(vt.type(this.name).length>1&&vt.type(this.name).indexAt("id",this.id)===0){this.logger.debug("이펙터 종료"),this.destroy();return}e*=.001,this.startTime||(this.startTime=e);const t=e-this.startTime;let s=0;const i=this.duration-(this.fadeInDuration+this.fadeOutDuration);t<=this.fadeInDuration?s=t/this.fadeInDuration:t<=this.fadeInDuration+i?s=1:t<=this.duration&&(s=1-(t-this.fadeInDuration-i)/this.fadeOutDuration),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),e+=.1,(a=this.renderFx)==null||a.call(this,this.ctx,this.canvas.width/2,this.canvas.height/2,s);const o=Math.floor(e);this.before=o,t<this.duration?this.effect=requestAnimationFrame(this.draw.bind(this)):(cancelAnimationFrame(this.effect),this.startTime=0,this.before=0,this.fadeInDuration=1,this.fadeOutDuration=1,this.duration=3,this.effect=void 0,(l=(r=this.canvas).remove)==null||l.call(r),this.destroy(),this.logger.log("이펙터 렌더링 완료"))}destroy(){vt.splice(vt.indexAt("id",this.id),1),clearInterval(this.effect),window.removeEventListener("resize",this.handleResizeOnce.bind(this)),this.canvas.remove(),this.before=0,this.events.forEach(e=>{e==null||e()}),this.events=[],this.isProcessed(!0)}run(){return new Promise(e=>{this.isProcessed=e,vt.push({id:this.id,type:this.name}),this.setupCanvas(),this.effect=requestAnimationFrame(this.draw.bind(this))})}}function xs({text:h,duration:e}){const s=new Se("textEffect");return s.fadeInDuration=1,s.fadeOutDuration=1,s.duration=e||5,s.renderFx=(i,o,a,r)=>{const l=Math.min(300,a),y=i.measureText(h);i.strokeStyle=f.Sign.White,i.lineWidth=2,i.font=`bold ${48*d.SCALE}px sans-serif`;const c=Math.ceil(r*255>50?50:r*255).toString(16).padStart(2,"0"),p=Math.ceil(r*255).toString(16).padStart(2,"0");i.fillStyle=f.Sign.Dark+c,i.fillRect(0,0,o*2,a*2),i.strokeStyle=f.Sign.White+p,i.fillStyle=f.Sign.Dark+p,i.strokeText(h,o-y.width/2,l),i.fillText(h,o-y.width/2,l)},s}const tt=h=>({...h}),ct=h=>({...h}),at=h=>({...h}),_t=h=>({...h});class Ct{constructor(e,t,s){n(this,"logger");n(this,"profileImageUrl");n(this,"unitTemp",null);n(this,"id");n(this,"nearSign",!1);n(this,"delayQueue",[]);n(this,"name");n(this,"color");n(this,"nameColor");n(this,"locate");n(this,"position",{x:0,y:0});n(this,"size");n(this,"state");n(this,"mapManager");n(this,"forwardField");n(this,"forwardPosition");n(this,"questionIndex",0);n(this,"questionList",[]);n(this,"dist");n(this,"imageScale",1.5);n(this,"currentAnimation");n(this,"currentAnimationIndex",0);n(this,"frame",0);n(this,"frameDir",!0);n(this,"fps",60);n(this,"frameRate",.2);this.id=ht("bd"),this.name=e,this.locate=t,s&&(this.position={x:s.x,y:s.y}),this.setSize(ct({x:x.PORTAL.X,y:x.PORTAL.Y})),this.setState(D.Walking),this.setNameColor(f.Name.Portal),this.setColor(f.Name.Normal),this.setAroundDistance(Q.DEFAULT.PORTAL.AROUND_DIST),this.setCurrentAnimation(S.Portal.Basic),this.setProfileImage(es.Basic),this.logger=new nt(this),this.logger.fixed.loaded(),Dt.push(this)}setProfileImage(e){this.profileImageUrl=e}setSize(e,t){typeof e=="number"?this.size=ct({x:e,y:t}):this.size=ct(e)}setPosition(e,t){this.position=tt({x:e,y:t})}setPositionByIndex(e,t){const s=ft(e,t);this.setPosition(s.x,s.y)}setImageScale(e){this.imageScale=e}setCurrentAnimationIndex(e){this.currentAnimationIndex=e}setCurrentAnimation(e){this.currentAnimation=e}setNameColor(e){this.nameColor=e}setColor(e){this.color=e}setAroundDistance(e){this.dist=e}setState(e){this.state=e}setMapManager(e){this.mapManager=e}setForwardField(e){e&&(this.forwardField=e)}setForwardPosition(e){this.forwardPosition=e}forward(){if(!this.forwardField||!this.forwardPosition){this.logger.debug("not set forward options");return}if(this.logger.debug(this.delayQueue),H.includes("forward"))return;const e=this.unitTemp;e&&(xs({text:this.name,duration:5}).run(),e.setLocate(this.forwardField.name),e.setPosition(this.forwardPosition.x,this.forwardPosition.y),e.lockMove(1),e.setCurrentAnimation(S.Character.Player.Front),[...this.mapManager.monsters.values()].forEach(s=>{s.locate!==e.locate&&s.nearFollowSign&&(clearTimeout(s.traceTimeout),s.stopTrace(),s.aroundPlayerTmp=s.aroundPlayerTmp.filter(i=>i.id!==e.id))}),H.push("forward"),this.mapManager.setGameField(this.forwardField),g.mode==="multi"&&this.mapManager.proxySocket.socket.send(JSON.stringify({type:"change/locate",id:e.id,locate:e.locate,x:e.position.x,y:e.position.y})),e.id===this.mapManager.controlUser.id&&e.syncGlobalPosition(),this.logger.debug("locate change",e.locate),setTimeout(()=>{H.splice(H.indexOf("forward"),1)},1e3),setTimeout(()=>{this.delayQueue=this.delayQueue.filter(s=>s!=="forward")},5e3))}around(e){const t=this.dist+this.size.x,s=Math.abs(this.position.x+this.size.x/2-(e.position.x+e.size.x/2)),i=Math.abs(this.position.y+this.size.y/2-(e.position.y+e.size.y/2));return Math.sqrt(s**2+i**2)<t?(this.nearSign=!0,this.unitTemp===null&&(this.unitTemp=e)):(this.nearSign=!1,this.unitTemp=null),this.nearSign}drawScale(e,t,s,i,o,a){e.fillStyle=f.Sign.Question,e.fillRect(t+(this.position.x+i-this.size.x/2)*a,s+(this.position.y+o-this.size.y)*a,this.size.x/1.5*a*1.5,this.size.y/1.5*a*1.5),e.font="bold 10px san-serif",e.textAlign="center",e.lineWidth=1,e.strokeStyle=f.Sign.White,e.strokeText(this.name,t+(this.position.x+i)*a,s+(this.position.y+o-this.size.y-20)*a),e.fillText(this.name,t+(this.position.x+i)*a,s+(this.position.y+o-this.size.y-20)*a)}draw(e,t){const[s,i]=rt(this.size);g.helper.portal.boundary.around&&this.showAroundBoudary(e,s,i);const o=this.fps*this.frameRate;this.frame=this.frame+(this.frameDir?1:-1)*1,this.currentAnimationIndex=Math.round(this.frame/o),(this.frame===o*2||this.frame===0)&&(this.frameDir=!this.frameDir);const a=this.state===D.Walking?this.currentAnimationIndex:1;e.drawImage(this.currentAnimation,this.size.x*a,0,this.size.x,this.size.y,this.position.x+s-this.size.x/2*(this.imageScale/2)/2,this.position.y+i,this.size.x*this.imageScale,this.size.y*this.imageScale),g.display.portal.name&&this.showDisplayName(t,s,i),g.helper.portal.sign&&this.showSignHelper(t,s,i)}showDisplayName(e,t,s){e.fillStyle=this.nameColor,e.font=`bold ${12*d.SCALE}px san-serif`,e.textAlign="center",e.lineWidth=2,e.strokeStyle=f.Sign.White,e.strokeText(this.name,this.position.x+t+this.size.x/2,this.position.y+s-this.size.y/5),e.fillText(this.name,this.position.x+t+this.size.x/2,this.position.y+s-this.size.y/5)}showAroundBoudary(e,t,s){const i=this.dist+this.size.x;this.nearSign?(e.strokeStyle=f.Sign.Near,e.fillStyle=f.Sign.Near+"56"):(e.strokeStyle=f.Sign.Dark+"56",e.fillStyle=f.Sign.None+"56"),e.beginPath(),e.arc(this.position.x+this.size.x/2+t,this.position.y+this.size.y/2+s,i-this.size.x/2,0,Math.PI*2),e.stroke(),e.fill()}showSignHelper(e,t,s){this.nearSign&&(e.textAlign="center",e.lineWidth=2,e.strokeStyle=f.Sign.White,e.fillStyle=f.Sign.Info,e.font=`bold ${32*d.SCALE}px sans-serif`,e.strokeText("?",this.position.x+t+this.size.x/2,this.position.y+s-this.size.y+this.size.y*this.imageScale/4),e.fillText("?",this.position.x+t+this.size.x/2,this.position.y+s-this.size.y+this.size.y*this.imageScale/4),e.lineWidth=1)}}class xe{constructor(e,t){n(this,"name");n(this,"fields",[]);this.name=e,this.fields=t}}class ws{constructor(){n(this,"logger");n(this,"fields",new Map);n(this,"id");this.id=ht("gm"),this.logger=new nt(this),this.logger.fixed.loaded()}add(e,t){const s=new xe(e,t);this.fields.set(s.name,s)}getMap(e){return this.fields.get(e)}}const ye=x.FIELD,j=["bush","block:grass","grass","tree","tree2","box"];class St{constructor(e,t,s){n(this,"logger");n(this,"id");n(this,"name");n(this,"type");n(this,"size",{x:ye,y:ye});n(this,"position",{x:0,y:0});n(this,"currentAnimation");n(this,"currentAnimationIndex",0);n(this,"frame",0);n(this,"frameDir",!0);n(this,"fps",60);n(this,"frameRate",.2);const{name:i,type:o}=Je[e];this.id=ht("fd"),this.name=i,this.type=o,this.position.x=t,this.position.y=s,this.logger=new nt(this)}static generate(e){return e.map((t,s)=>t.map((i,o)=>new St(i,o,s)))}fieldColor(e){this.name==="wall"&&(e.fillStyle="black"),this.name==="grass"&&(e.fillStyle="black"),this.name==="road"&&(e.fillStyle="grey")}drawAnimateTile(e,t,s,i){const o=[S.Sprites.Tileset1,S.Sprites.Tileset2],a=[[3,15],[4,10]],r=this.fps*this.frameRate;this.frame=this.frame+(this.frameDir?1:-1)*1,this.currentAnimationIndex=Math.round(this.frame/r),(this.frame===r*2||this.frame===0)&&(this.frameDir=!this.frameDir);const l=this.currentAnimationIndex,[y,c]=a[l%2],p=32,u=32,w=this.size.x,k=this.size.y,[E,z]=qt({x:s,y:i});e.drawImage(o[0],p*3+.07,u*15+.07,p-.7,u-.7,this.position.x*w+E,this.position.y*k+z-.2,w-.1,k-.1),e.drawImage(o[l%2],p*y+.07,u*c+.07,p,u,this.position.x*w+E+l+1.6,this.position.y*k+z+1.6,w-.58,k-.58)}drawScale(e,t,s,i){const o=re(this.name);e.fillStyle="transparent",this.contains(this.name,j)?(e.drawImage(S.Sprites.Grass,t+this.position.x*this.size.x*i,s+this.position.y*this.size.y*i,this.size.x*i,this.size.y*i),this.name==="tree"&&e.drawImage(S.Sprites.Object,5,0,60,100,t+this.position.x*this.size.x*i,s+this.position.y*this.size.y*i,this.size.x*i,this.size.y*i),this.name==="tree2"&&e.drawImage(S.Sprites.Object,55,0,75,100,t+this.position.x*this.size.x*i,s+this.position.y*this.size.y*i,this.size.x*i,this.size.y*i)):e.drawImage(S.Sprites[o],t+this.position.x*this.size.x*i,s+this.position.y*this.size.y*i,this.size.x*i,this.size.y*i)}drawTile(e,t,s,i,o,a,r){const c=this.size.x,p=this.size.y,[u,w]=qt({x:a,y:r});e.drawImage(s,32*i+.17,32*o+.17,32,32,this.position.x*c+u,this.position.y*p+w,c+.58,p+.58)}contains(e,t){return t.some(s=>e===s)}drawTileset(e,t,s,i,o){var a,r,l,y,c,p,u,w,k,E,z,X,F,J,G,_;try{const m=S.Sprites.Tileset1,N=this.size.x,C=this.size.y,[Y,R]=qt({x:i,y:o});t.fillStyle="transparent";const P=this.position.x,B=this.position.y,v=(r=(a=s.gameField.fields)==null?void 0:a[B-1])==null?void 0:r[P],W=(y=(l=s.gameField.fields)==null?void 0:l[B-1])==null?void 0:y[P-1],M=(p=(c=s.gameField.fields)==null?void 0:c[B-1])==null?void 0:p[P+1],A=(w=(u=s.gameField.fields)==null?void 0:u[B+1])==null?void 0:w[P],et=(E=(k=s.gameField.fields)==null?void 0:k[B+1])==null?void 0:E[P-1],st=(X=(z=s.gameField.fields)==null?void 0:z[B+1])==null?void 0:X[P+1],I=(J=(F=s.gameField.fields)==null?void 0:F[B])==null?void 0:J[P-1],T=(_=(G=s.gameField.fields)==null?void 0:G[B])==null?void 0:_[P+1];if(g.helper.map.grid&&t.strokeRect(this.position.x*N+Y,this.position.y*C+R,N,C),this.name==="water"&&this.drawAnimateTile(t,s,i,o),this.contains(this.name,j)&&(this.drawTile(t,s,m,1,5,i,o),(v==null?void 0:v.name)==="water"?(this.drawTile(t,s,m,5,4,i,o),(I==null?void 0:I.name)==="water"&&this.drawTile(t,s,m,4,4,i,o),(T==null?void 0:T.name)==="water"&&this.drawTile(t,s,m,6,4,i,o)):(A==null?void 0:A.name)==="water"?(this.drawTile(t,s,m,5,6,i,o),(I==null?void 0:I.name)==="water"&&this.drawTile(t,s,m,4,6,i,o),(T==null?void 0:T.name)==="water"&&this.drawTile(t,s,m,6,6,i,o)):(I==null?void 0:I.name)==="water"?this.drawTile(t,s,m,4,5,i,o):(T==null?void 0:T.name)==="water"?this.drawTile(t,s,m,6,5,i,o):(W==null?void 0:W.name)==="water"&&this.contains(I==null?void 0:I.name,j)&&this.contains(v==null?void 0:v.name,j)?this.drawTile(t,s,m,3,9,i,o):(M==null?void 0:M.name)==="water"&&this.contains(T==null?void 0:T.name,j)&&this.contains(v==null?void 0:v.name,j)?this.drawTile(t,s,m,2,9,i,o):(et==null?void 0:et.name)==="water"&&this.contains(I==null?void 0:I.name,j)&&this.contains(A==null?void 0:A.name,j)?this.drawTile(t,s,m,3,8,i,o):(st==null?void 0:st.name)==="water"&&this.contains(T==null?void 0:T.name,j)&&this.contains(A==null?void 0:A.name,j)&&this.drawTile(t,s,m,2,8,i,o),this.name==="tree"&&e.drawImage(S.Sprites.Object,5,0,60,100,this.position.x*N+Y-10,this.position.y*C+R-30-((A==null?void 0:A.name)==="water"?15:0),N+15,C+35),this.name==="tree2"&&e.drawImage(S.Sprites.Object,60,0,75,100,this.position.x*N+Y-10,this.position.y*C+R-30,N+15,C+35),this.name==="bush"&&e.drawImage(S.Sprites.Object,0,150,40,45,this.position.x*N+Y-14,this.position.y*C+R-15,80,90),this.name==="box"&&e.drawImage(S.Sprites.Object,0,5+45*5,50,50,this.position.x*N+Y-1.5,this.position.y*C+R,50,50)),this.name==="road"){this.drawTile(t,s,m,1,1,i,o),v&&this.contains(v.name,j)&&this.drawTile(t,s,m,1,0,i,o);const Te=A&&this.contains(A.name,j),Ee=this.contains(W==null?void 0:W.name,j)&&(I==null?void 0:I.name)==="road"&&(v==null?void 0:v.name)==="road",Me=this.contains(M==null?void 0:M.name,j)&&(T==null?void 0:T.name)==="road"&&(v==null?void 0:v.name)==="road",Ue=this.contains(et==null?void 0:et.name,j)&&(I==null?void 0:I.name)==="road"&&(A==null?void 0:A.name)==="road",Le=this.contains(st==null?void 0:st.name,j)&&(T==null?void 0:T.name)==="road"&&(A==null?void 0:A.name)==="road";Te?this.drawTile(t,s,m,1,2,i,o):Ee?this.drawTile(t,s,m,5,9,i,o):Me?this.drawTile(t,s,m,4,9,i,o):Ue?this.drawTile(t,s,m,5,8,i,o):Le&&this.drawTile(t,s,m,4,8,i,o);const ze=I&&this.contains(I.name,j),De=T&&this.contains(T.name,j);if(ze){this.drawTile(t,s,m,0,1,i,o);const qe=v&&this.contains(v.name,j),Oe=A&&this.contains(A.name,j);qe&&this.drawTile(t,s,m,6,8,i,o),Oe&&this.drawTile(t,s,m,6,9,i,o)}else De&&(this.drawTile(t,s,m,2,1,i,o),v&&this.contains(v.name,j)&&this.drawTile(t,s,m,7,8,i,o),A&&this.contains(A.name,j)&&this.drawTile(t,s,m,7,9,i,o));const Ne=(W==null?void 0:W.name)==="water"&&(I==null?void 0:I.name)==="road"&&(v==null?void 0:v.name)==="road",Ce=(M==null?void 0:M.name)==="water"&&(T==null?void 0:T.name)==="road"&&(v==null?void 0:v.name)==="road",Pe=(et==null?void 0:et.name)==="water"&&(I==null?void 0:I.name)==="road"&&(A==null?void 0:A.name)==="road",Be=(st==null?void 0:st.name)==="water"&&(T==null?void 0:T.name)==="road"&&(A==null?void 0:A.name)==="road";(v==null?void 0:v.name)==="water"?(this.drawTile(t,s,m,5,0,i,o),(I==null?void 0:I.name)==="water"&&this.drawTile(t,s,m,4,0,i,o),(T==null?void 0:T.name)==="water"&&this.drawTile(t,s,m,6,0,i,o)):(A==null?void 0:A.name)==="water"?(this.drawTile(t,s,m,5,2,i,o),(I==null?void 0:I.name)==="water"&&this.drawTile(t,s,m,4,2,i,o),(T==null?void 0:T.name)==="water"&&this.drawTile(t,s,m,6,2,i,o)):(I==null?void 0:I.name)==="water"?this.drawTile(t,s,m,4,1,i,o):(T==null?void 0:T.name)==="water"?this.drawTile(t,s,m,6,1,i,o):Ne?this.drawTile(t,s,m,1,9,i,o):Ce?this.drawTile(t,s,m,0,9,i,o):Pe?this.drawTile(t,s,m,1,8,i,o):Be&&this.drawTile(t,s,m,0,8,i,o)}}catch{}}draw(e,t,s){const i=this.size.x,o=this.size.y,[a,r]=qt({x:t,y:s});e.fillStyle="transparent";const l=re(this.name);l in S.Sprites?(this.contains(this.name,["tree"])&&e.drawImage(S.Sprites.Grass,this.position.x*i+a,this.position.y*o+r,i,o),e.drawImage(S.Sprites[l],this.position.x*i+a,this.position.y*o+r,i,o)):(this.fieldColor(e),e.fillRect(this.position.x*i+a,this.position.y*o+r,this.size.x,this.size.y))}}const ks=St.generate([["0","0","0","3","0","0","0","3","0","1","1","1","1","0","0","0","0","1","1","0","0","0"],["0","1","1","1","1","1","1","1","1","1","1","1","1","0","0","0","0","1","1","0","0","0"],["0","1","1","1","1","1","1","1","1","1","1","1","1","0","0","0","0","1","1","0","0","0"],["0","1","1","2","2","2","2","2","1","1","0","0","0","0","3","0","0","1","1","0","0","0"],["0","1","1","2","2","2","2","2","1","1","0","0","0","0","0","0","3","1","1","0","0","0"],["3","1","1","2","2","2","2","2","1","1","0","0","0","0","0","0","0","1","1","3","0","0"],["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","0","0"],["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","0","0"],["0","0","0","1","1","3","0","0","4","1","1","1","1","0","0","0","0","1","1","0","0","0"],["0","0","3","1","1","0","0","5","0","1","1","1","1","0","0","0","0","1","1","0","0","0"],["0","0","0","1","1","0","0","0","0","1","1","1","1","a","a","a","3","1","1","3","0","0"],["0","0","0","1","1","0","0","3","0","1","1","1","1","a","a","a","3","1","1","0","0","0"],["0","0","0","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"],["0","0","0","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"],["0","0","0","1","1","0","0","0","3","1","1","1","1","0","0","0","0","1","1","0","0","0"],["0","0","0","1","1","0","0","0","0","1","1","1","1","3","0","0","0","1","1","0","0","0"],["0","0","0","1","1","0","0","0","0","1","1","1","1","3","0","0","3","1","1","0","0","0"],["0","0","0","1","1","0","0","0","0","1","1","1","1","0","0","0","3","1","1","0","0","0"]]),vs=St.generate([["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"]]),As=St.generate([["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"],["0","0","0","0","0","0","0","0","0","0","0","1","1","0","0","0","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","1","1","0","0","0","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","1","1","a","a","a","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","1","1","a","a","a","0","0","0"],["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","3","2","2","2","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","2","2","2","2","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","2","2","2","2","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","0","2","2","2","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"]]),bs=St.generate([["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"]]),Is=St.generate([["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","0","5","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["0","0","0","5","0","0","0","0","0","0","0","0","0","5","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["0","0","0","0","0","0","0","0","0","0","5","0","0","0","0","0"],["0","0","0","0","6","0","0","0","0","0","0","0","0","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["0","0","0","0","0","0","0","5","0","0","0","0","0","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["0","0","0","0","5","0","0","0","0","0","5","0","0","0","0","0"],["0","0","0","0","0","0","4","0","0","0","0","0","0","0","0","0"],["0","0","0","0","0","4","4","4","0","0","0","0","0","0","5","0"],["0","0","0","0","0","4","4","4","4","0","0","0","0","0","0","0"],["0","0","0","0","4","4","4","4","4","0","0","0","0","0","0","0"]]),Ts=St.generate([["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"],["1","1","1","1","1","1","1","1","1","1","1"]]),Z=new ws;Z.add(L.BASE_COUNTRY,ks);Z.add(L.BASE_FIELD_1,As);Z.add(L.MAIN_HOUSE,vs);Z.add(L.HOUSE,bs);Z.add(L.DESTROYED_COUNTRY,Is);Z.add(L.DESTROYED_HOUSE1,Ts);const mt={INIT:{x:0*d.SCALE,y:0*d.SCALE},BASE_COUNTRY:{x:0*d.SCALE,y:0*d.SCALE},BASE_FIELD_1:{x:0*d.SCALE,y:0*d.SCALE}},Es=`ws://localhost:8081${gt}`,Ht={Basic:`${gt}profiles/npc/basic.png`,Gm:`${gt}profiles/npc/gm.png`,Chonjang:`${gt}profiles/npc/chonjang.png`,Namoo:`${gt}profiles/npc/namoo.png`};class Ms{constructor(){n(this,"logger");n(this,"subscribers",{});this.logger=new nt(this),this.logger.fixed.loaded()}getSubscribersBy(e){return this.subscribers[e]}subscribe({eventType:e,subscriber:t}){this.subscribers[e]||(this.subscribers[e]=[]),this.subscribers[e].push(t)}unsubscribe({eventType:e,subscriber:t}){this.subscribers[e]=this.subscribers[e].filter(s=>s!==t)}notify(e,t){this.emit(e,t)}size(e){const t={},s=Object.values(this.subscribers).flat(1).length;if(t.all=s,e in this.subscribers){const i=this.subscribers[e].length;t[e]=i}return t}emit(e,t){this.getSubscribersBy(e).forEach(i=>i(t))}}const Us=new Ms;class K{constructor(e){n(this,"logger");n(this,"eventType");n(this,"publisher",Us);this.eventType=e,this.logger=new nt(this),this.logger.fixed.loaded()}subscribe(e){this.logger.debug("구독 상태:",this.eventType),this.publisher.subscribe({eventType:this.eventType,subscriber:e})}unsubscribe(e){this.publisher.unsubscribe({eventType:this.eventType,subscriber:e})}dispatch(e){this.publisher.notify(this.eventType,e)}}class Zt{constructor(e,t){n(this,"logger");n(this,"profileImageUrl");n(this,"imageScale",1);n(this,"level",0);n(this,"exp",99);n(this,"aroundTmp",null);n(this,"nearSign",!1);n(this,"untouchable");n(this,"delayQueue",[]);n(this,"id");n(this,"name");n(this,"locate");n(this,"state");n(this,"isRunning");n(this,"gravity");n(this,"size");n(this,"stat");n(this,"position");n(this,"statPoint",0);n(this,"shootingable",!1);n(this,"fly",!1);n(this,"velocity");n(this,"color");n(this,"nameColor");n(this,"health");n(this,"mana");n(this,"maxHealth");n(this,"maxMana");n(this,"dist");n(this,"attackDist");n(this,"currentAnimation");n(this,"currentAnimationIndex",0);n(this,"frame",0);n(this,"frameDir",!0);n(this,"fps",60);n(this,"frameRate",.2);n(this,"spawnPoint");n(this,"aroundUnit",null);n(this,"hitColors",[f.Sign.SkyBule,f.Sign.White]);const s=at({str:5,dex:5,int:5,luck:5}),i=tt(mt.INIT),o=_t({increase:ot.VELOCITY.UNIT.INCREASE,speed:ot.VELOCITY.UNIT.BASE,jump:ot.VELOCITY.UNIT.JUMP,maxSpeed:ot.VELOCITY.UNIT.LIMIT,attack:ot.VELOCITY.UNIT.ATTACK});this.id=t??ht("ut"),this.name=e,this.locate=g.defaultSpawn,this.isRunning=!1,this.gravity=1,this.setSize(ct({x:x.UNIT.X,y:x.UNIT.Y})),this.setState(D.None),this.setStat(s),this.setPosition(i.x,i.y),this.setVelocity(o),this.setProfileImage(Ht.Basic),this.untouchable=!1,this.initialHealthMana(Q.DEFAULT.UNIT.HEALTH,Q.DEFAULT.UNIT.MANA),this.setCurrentAnimation(S.Character.Player.Front),this.setAroundDistance(Q.DEFAULT.UNIT.AROUND_DIST),this.setAttackDistance(Q.DEFAULT.UNIT.ATTACK_DIST),this.setColor(f.Name.Normal),this.setNameColor(f.Name.Normal),this.logger=new nt(this),this.logger.fixed.loaded(),Dt.push(this)}aroundPlayer(e){const t=this.dist+this.size.x,s=Math.abs(this.position.x+this.size.x/2-(e.position.x+e.size.x/2)),i=Math.abs(this.position.y+this.size.y/2-(e.position.y+e.size.y/2)),a=180*Math.atan2(e.position.y-this.position.y,e.position.x-this.position.x)/Math.PI,r=(360+Math.round(a))%360;return Math.sqrt(s**2+i**2)<t?(this.aroundUnit=e,this.nearSign=!0,0<r&&r<45||360>r&&r>315?this.setCurrentAnimation(S.Character.Player.Right):315>r&&r>225?this.setCurrentAnimation(S.Character.Player.Back):225>r&&r>135?this.setCurrentAnimation(S.Character.Player.Left):this.setCurrentAnimation(S.Character.Player.Front)):(this.aroundUnit=null,this.nearSign=!1),this.health===0&&(this.aroundUnit=null,this.nearSign=!1),this.aroundUnit}reSpawn(e){this.state=D.ReSpawning,setTimeout(()=>{this.health=this.maxHealth,this.mana=this.maxMana;const s=Math.floor(Math.random()*50*d.SCALE),i=Math.round(Math.random())===1?1:-1,o={x:this.spawnPoint.x+i*s,y:this.spawnPoint.y+i*s};this.position=tt(o),this.state=D.Walking},e*1e3)}setProfileImage(e){this.profileImageUrl=e}shootable(){this.shootingable=!0}disshootable(){this.shootingable=!1}flyable(){this.fly=!0}disflyable(){this.fly=!1}setImageScale(e){this.imageScale=e}setCurrentAnimationIndex(e){this.currentAnimationIndex=e}setCurrentAnimation(e){this.currentAnimation=e}setColor(e){this.color=e}setNameColor(e){this.nameColor=e}initialHealthMana(e,t){this.setHealth(e),this.setMaxHealth(e),this.setMana(t),this.setMaxMana(t)}setMoveSpeed(e,t){t&&(this.velocity.increase=t*d.SCALE),this.velocity.maxSpeed=e*d.SCALE,e*d.SCALE>=ot.VELOCITY.UNIT.LIMIT-1*d.SCALE&&this.logger.error("몬스터 속도가 기본 유닛 스피드 보다 빠릅니다!")}setVelocity(e){this.velocity=_t(e)}setSize(e,t){typeof e=="number"?this.size=ct({x:e,y:t}):this.size=ct(e)}setStat(e){this.stat=at(e)}setState(e){this.state=e}setMaxHealth(e){this.maxHealth=e}setMaxMana(e){this.maxMana=e}isPossibleLevelUp(){return this.exp>=this.calculateExpForLevelUp()}calculateExpForLevelUp(){return parseFloat(((this.level+1)*100+this.level*150).toFixed(2))}levelUpAndReturnRestExp(){return this.isPossibleLevelUp()&&(this.exp=parseFloat((this.exp-this.calculateExpForLevelUp()).toFixed(2)),this.levelUp()),this.exp}addStatPoint(e){this.statPoint+=e}calculateUnitDamage(){return Math.floor(this.stat.str)}getExpAndPercentage(){const e=this.calculateExpForLevelUp(),t=parseFloat((this.exp/e*100).toFixed(2));return{exp:this.exp,maxExp:e,percentage:t}}levelUp(){this.level+=1,this.addStatPoint(4),this.healing(Math.floor(this.health/2))}addExp(e){if(this.exp=parseFloat((this.exp+e).toFixed(2)),this.isPossibleLevelUp()){const a=this.levelUpAndReturnRestExp();this.logger.info("레벨 업 후 현재 Exp:",a),new K("level-up-ex").dispatch({unit:this})}const t=new K("exp-update"),{exp:s,maxExp:i,percentage:o}=this.getExpAndPercentage();t.dispatch({unit:this,exp:s,maxExp:i,percentage:o,statPoint:this.statPoint})}healing(e){const t=this.maxHealth<=e+this.health,i=Number.isFinite(e)&&t?this.maxHealth:e+this.health;this.health=i}manaling(e){const t=this.maxMana<=e+this.mana,i=Number.isFinite(e)&&t?this.maxMana:e;this.mana=i}setHealth(e){const t=this.maxHealth<e?this.maxHealth:e;this.health=t}setMana(e){const t=this.maxMana<e?this.maxMana:e;this.mana=t}setLocate(e){this.locate=e}setDefaultSpawnLocate(e){this.setLocate(e)}move(e,t){this.delayQueue.includes("move")||(this.position.x=parseFloat((this.position.x+e).toFixed(2)),this.position.y=parseFloat((this.position.y+t).toFixed(2)))}die(){this.delayQueue=this.delayQueue.filter(e=>e!=="shooting"),this.delayQueue=this.delayQueue.filter(e=>e!=="attack"),this.setState(D.Dead),this.nearSign=!1,this.velocity.speed=0,this.lockMove(1.5),this.logger.info(this.delayQueue),new K("respawn").dispatch(this)}lockMove(e){this.delayQueue.push("move"),setTimeout(()=>{this.delayQueue=this.delayQueue.filter(t=>t!=="move")},e*1e3)}setPositionByIndex(e,t){const s=ft(e,t);this.setPosition(s.x,s.y)}setPosition(e,t){this.position=tt({x:e,y:t}),this.spawnPoint=tt(this.position)}syncGlobalPosition(){d.VIEW.x=this.position.x,d.VIEW.y=this.position.y}setAroundDistance(e){this.dist=e}setAttackDistance(e){this.attackDist=e}setAttackDelay(e){this.velocity.attack=e}around(e){const t=(this.constructor.name==="Monster"?this.attackDist:this.dist)+this.size.x;for(const s of e){if(s===this)continue;const i=Math.abs(this.position.x+this.size.x/2-(s.position.x+s.size.x/2)),o=Math.abs(this.position.y+this.size.y/2-(s.position.y+s.size.y/2));Math.sqrt(i**2+o**2)<t?(this.aroundTmp===null&&(this.aroundTmp=[]),this.aroundTmp.includes(s)||this.aroundTmp.push(s),this.nearSign=!0):(this.aroundTmp=null,this.nearSign=!1)}}showName(e,t,s,i){e.textAlign="center",e.fillStyle=this.nameColor,e.font=`bold ${12*d.SCALE}px sans-serif`;const a="Lv."+this.level+" "+this.name;e.lineWidth=2,e.strokeStyle=f.Sign.White,e.strokeText(a,this.position.x+t+x.UNIT.X/2,this.position.y+s-x.UNIT.X/5-5*d.SCALE-10*i*d.SCALE),e.fillText(a,this.position.x+t+x.UNIT.X/2,this.position.y+s-x.UNIT.X/5-5*d.SCALE-10*i*d.SCALE)}showHealthBar(e,t,s,i){e.fillStyle=f.Sign.Grey,e.fillRect(this.position.x+t-x.UNIT.X/2,this.position.y+s-x.UNIT.X/5-10*d.SCALE-10*i*d.SCALE,this.size.x*2,10*d.SCALE),e.fillStyle=f.Sign.Health,e.fillRect(this.position.x+t-x.UNIT.X/2,this.position.y+s-x.UNIT.X/5-10*d.SCALE-10*i*d.SCALE,this.size.x*2*(this.health/this.maxHealth),10*d.SCALE),e.fillStyle=f.Sign.Dark,e.textAlign="center",e.font=`bold ${8*d.SCALE}px sans-serif`,e.fillText(""+this.health+" / "+this.maxHealth,this.position.x+t+x.UNIT.X/2,this.position.y+s-x.UNIT.X/5-10*i*d.SCALE-2*d.SCALE)}showManaBar(e,t,s,i){e.fillStyle=f.Sign.Grey,e.fillRect(this.position.x+t-x.UNIT.X/2,this.position.y+s-x.UNIT.X/5-10*d.SCALE-10*i*d.SCALE,this.size.x*2,10*d.SCALE),e.fillStyle=f.Sign.Mana,e.fillRect(this.position.x+t-x.UNIT.X/2,this.position.y+s-x.UNIT.X/5-10*d.SCALE-10*i*d.SCALE,this.size.x*2*(this.mana/this.maxMana),10*d.SCALE),e.fillStyle=f.Sign.White,e.textAlign="center",e.font=`bold ${8*d.SCALE}px sans-serif`,e.fillText(""+this.mana+" / "+this.maxMana,this.position.x+t+x.UNIT.X/2,this.position.y+s-x.UNIT.X/5-10*i*d.SCALE-2*d.SCALE)}drawScale(e,t,s,i,o,a){e.fillStyle=f.Sign.Mana,e.fillRect(t+(this.position.x+i-this.size.x/2)*a,s+(this.position.y+o-this.size.y/2)*a,this.size.x*a,this.size.y*a)}draw(e,t,s,i){const o=this.fps*this.frameRate;this.frame=this.frame+(this.frameDir?1:-1)*1,this.currentAnimationIndex=Math.round(this.frame/o),(this.frame===o*2||this.frame===0)&&(this.frameDir=!this.frameDir);const[a,r]=rt(this.size);e.fillStyle=this.color;const l=this.state===D.Walking?this.currentAnimationIndex:1;e.drawImage(this.currentAnimation,this.size.x*l,0,this.size.x,this.size.y,this.position.x+a-this.size.x/2*(this.imageScale-1)/2,this.position.y+r-this.size.y/2*(this.imageScale-1)/2,this.size.x*this.imageScale,this.size.y*this.imageScale)}}class we extends Se{constructor(e){super(e)}draw(e){var a,r,l;e*=.001,this.startTime||(this.startTime=e);const t=e-this.startTime;let s=0;const i=this.duration-(this.fadeInDuration+this.fadeOutDuration);t<=this.fadeInDuration?s=t/this.fadeInDuration:t<=this.fadeInDuration+i?s=1:t<=this.duration&&(s=1-(t-this.fadeInDuration-i)/this.fadeOutDuration),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),e+=.1,this.ctx.font="bold 32px sans-serif",(a=this.renderFx)==null||a.call(this,this.ctx,this.canvas.width/2,this.canvas.height/2,s);const o=Math.floor(e);this.before=o,t<this.duration?this.effect=requestAnimationFrame(this.draw.bind(this)):(cancelAnimationFrame(this.effect),this.startTime=0,this.before=0,this.fadeInDuration=1,this.fadeOutDuration=1,this.duration=3,this.effect=void 0,(l=(r=this.canvas).remove)==null||l.call(r),this.logger.log("done"),this.destroy())}}function ke(h,e,t,s){let i=0;const o=new we("hitCountEffect"),a=innerWidth/2,r=innerHeight/2;return o.fadeInDuration=.5,o.fadeOutDuration=.5,o.duration=t,o.renderFx=(l,y,c,p)=>{const u="ff",w=l.measureText(h);if(l.textAlign="center",l.lineWidth=2,l.strokeStyle=f.Sign.White,l.font=`bold ${32*d.SCALE}px sans-serif`,Array.isArray(s)){const k=l.createLinearGradient(e.position.x+a-d.VIEW.x,e.position.y+r-d.VIEW.y-e.size.y-w.fontBoundingBoxAscent*1.5-i,e.position.x+a-d.VIEW.x,e.position.y+r-d.VIEW.y-e.size.y-w.fontBoundingBoxAscent/2-i);s.forEach((E,z)=>{k.addColorStop(z/s.length,E+u)}),l.fillStyle=k}else l.fillStyle=s??"green";l.strokeText(h,e.position.x+a-d.VIEW.x,e.position.y+r-d.VIEW.y-e.size.y-w.fontBoundingBoxAscent-i),l.fillText(h,e.position.x+a-d.VIEW.x,e.position.y+r-d.VIEW.y-e.size.y-w.fontBoundingBoxAscent-i),i+=1,l.lineWidth=1},o}class dt extends Zt{constructor(t,s){const i=at({str:7,dex:5,int:5,luck:5}),o=_t({increase:ot.VELOCITY.MONSTER.INCREASE,speed:ot.VELOCITY.MONSTER.BASE,jump:ot.VELOCITY.MONSTER.JUMP,maxSpeed:ot.VELOCITY.MONSTER.LIMIT,attack:ot.VELOCITY.MONSTER.ATTACK});super(t,s);n(this,"timer",0);n(this,"attackInterval");n(this,"dropExp");n(this,"dropMoney");n(this,"dropItems",[]);n(this,"aroundPlayerTmp",[]);n(this,"aroundFollowTmp",[]);n(this,"nearFollowSign",!1);n(this,"traceTimeout");n(this,"traceTime");n(this,"hitColors",[f.Sign.Attacking,f.Sign.White]);this.id=s??ht("mst"),this.setSize(ct({x:x.MONSTER.X,y:x.MONSTER.Y})),this.setStat(i),this.setState(D.Walking),this.setCurrentAnimation(S.Character.Monster.SlimeFront),this.setVelocity(o),this.setTraceTime(10),this.disflyable(),this.disshootable(),this.setNameColor(ge.A),this.setAroundDistance(Q.DEFAULT.MONSTER.AROUND_DIST),this.setAttackDistance(Q.DEFAULT.MONSTER.ATTACK_DIST),this.setDropMoney(Q.DEFAULT.MONSTER.MONEY)}setDropMoney(t){this.dropMoney=t}setDropExp(t){this.dropExp=t}showNearSignHelper(t,s,i){this.nearFollowSign&&(t.textAlign="center",t.lineWidth=2,t.strokeStyle=f.Sign.White,t.fillStyle=f.Sign.Attacking,t.font=`bold ${32*d.SCALE}px san-serif`,t.strokeText("!",this.position.x+s+this.size.x/2,this.position.y+i-this.size.y),t.fillText("!",this.position.x+s+this.size.x/2,this.position.y+i-this.size.y),t.lineWidth=1)}showAroundBoundaryHelper(t,s,i){const o=this.dist+this.size.x;this.aroundFollowTmp.find(r=>{const l=Math.abs(this.position.x+this.size.x/2-(r.position.x+r.size.x/2)),y=Math.abs(this.position.y+this.size.y/2-(r.position.y+r.size.y/2));return Math.sqrt(l**2+y**2)<o})||this.nearFollowSign?(t.strokeStyle=f.Sign.Attacked,t.fillStyle=f.Sign.Attacked+"56"):(t.strokeStyle=f.Sign.Dark+"56",t.fillStyle=f.Sign.None+"56"),t.beginPath(),t.arc(this.position.x+this.size.x/2+s,this.position.y+this.size.y/2+i,o-this.size.x/2,0,Math.PI*2),t.stroke(),t.fill()}showAttackBoundaryHelper(t,s,i){var r;const o=this.attackDist+this.size.x;((r=this.aroundPlayerTmp)==null?void 0:r.find(l=>{const y=Math.abs(this.position.x+this.size.x/2-(l.position.x+l.size.x/2)),c=Math.abs(this.position.y+this.size.y/2-(l.position.y+l.size.y/2));return Math.sqrt(y**2+c**2)<o}))||this.nearSign?(t.strokeStyle=f.Sign.Attackable,t.fillStyle=f.Sign.Attackable+"56"):(t.strokeStyle=f.Sign.Dark+"56",t.fillStyle=f.Sign.None+"56"),t.beginPath(),t.arc(this.position.x+this.size.x/2+s,this.position.y+this.size.y/2+i,o-this.size.x/2,0,Math.PI*2),t.stroke(),t.fill()}attack(t){if(this.state===D.Dead)return;this.logger.info(this.name+">"+t.name+":",t.health,this.name);const s=this.calculateUnitDamage(),i=Math.floor(this.stat.dex*Math.random()),o=t.health-(s+i);t&&(t.health>0&&o<=0?(this.logger.info("unit dead."),t.health=0,t.die(),this.stopTrace(),t instanceof dt||setTimeout(()=>{H.includes("control unit die")||H.push("control unit die")},1*1e3),this.aroundFollowTmp=[],this.aroundPlayerTmp=[],this.nearFollowSign=!1,this.nearSign=!1):t.health=o),ke((s+i).toString(),t,1,this.hitColors).run()}attackTarget(t,s){for(const i of this.aroundPlayerTmp){const o=this.attackDist+this.size.x,a=Math.abs(this.position.x+this.size.x/2-(i.position.x+i.size.x/2)),r=Math.abs(this.position.y+this.size.y/2-(i.position.y+i.size.y/2));Math.sqrt(a**2+r**2)<o&&(this.attack(i),g.mode==="multi"&&s.send(JSON.stringify({type:"sync/player/info",id:i.id,health:i.health,mana:i.mana,maxHealth:i.maxHealth,maxMana:i.maxMana})))}}aroundAttack(t,s){if(this.aroundFollowTmp.length===0&&this.aroundPlayerTmp.length===0){clearInterval(this.attackInterval),this.attackInterval=void 0;return}else this.attackInterval===void 0&&this.aroundPlayerTmp.length>0&&(this.timer+=1,this.attackTarget(t,s),this.attackInterval=setInterval(this.attackTarget.bind(this,t,s),this.velocity.attack*1e3))}aroundAttackablePlayer(t){const s=this.attackDist+this.size.x,i=this.dist+this.size.x,o=Math.abs(this.position.x+this.size.x/2-(t.position.x+t.size.x/2)),a=Math.abs(this.position.y+this.size.y/2-(t.position.y+t.size.y/2)),r=Math.sqrt(o**2+a**2);t.health>0&&r<s?(this.aroundPlayerTmp.includes(t)||this.aroundPlayerTmp.push(t),this.nearSign=!0):(this.aroundPlayerTmp=this.aroundPlayerTmp.filter(l=>l.id!==t.id),this.aroundPlayerTmp.length===0&&(this.nearSign=!1)),t.health>0&&r<i?(this.aroundFollowTmp.includes(t)||this.aroundFollowTmp.push(t),this.nearFollowSign=!0,this.traceTimeout!==void 0&&(this.logger.debug("initial timeout"),clearTimeout(this.traceTimeout),this.traceTimeout=void 0),t.health<=0&&this.stopTrace()):this.nearFollowSign&&(this.traceTimeout===void 0&&(this.logger.debug("start timeout"),this.traceTimeout=setTimeout(()=>{this.traceTimeout!==void 0&&this.stopTrace()},this.traceTime*1e3)),t.health<=0&&this.stopTrace())}die(){super.die(),this.stopTrace()}autoMove(t){}setTraceTime(t){this.traceTime=t}stopTrace(){clearInterval(this.attackInterval),clearTimeout(this.traceTimeout),this.delayQueue=this.delayQueue.filter(t=>t!=="shooting"),this.delayQueue=this.delayQueue.filter(t=>t!=="attack"),this.aroundFollowTmp=[],this.aroundPlayerTmp=[],this.nearFollowSign=!1,this.nearSign=!1,this.traceTimeout=void 0,this.velocity.speed=0}tracing(t,s){const i=this.velocity.increase,o=this.velocity.speed<this.velocity.maxSpeed?this.velocity.speed=parseFloat((this.velocity.speed+i).toFixed(2)):this.velocity.speed,a=t.position.x<=this.position.x?-1:1,r=t.position.y+t.size.y/2-this.size.y*this.imageScale/2<=this.position.y?-1:1;r===-1&&!s.collisionUp(this)&&this.move(0,-1*o),r===1&&!s.collisionDown(this)&&this.move(0,o),a===-1&&!s.collisionLeft(this)&&this.move(-1*o,0),a===1&&!s.collisionRight(this)&&this.move(o,0)}drawScale(t,s,i,o,a,r){t.fillStyle=f.Sign.Health,t.fillRect(s+(this.position.x+o-this.size.x/2)*r,i+(this.position.y+a-this.size.y/2)*r,this.size.x*r,this.size.y*r)}draw(t,s,i,o){const[a,r]=rt(this.size);g.helper.monster.boundary.attack&&this.showAttackBoundaryHelper(t,a,r),g.helper.monster.boundary.around&&this.showAroundBoundaryHelper(t,a,r),super.draw(t,s,i,o);const l=g.display.monster.name,y=g.display.monster.health,c=g.display.monster.mana;let p=Number(l)+Number(y)+Number(c);l&&(p-=1,this.showName(s,a,r,p)),y&&(p-=1,this.showHealthBar(s,a,r,p)),c&&(p-=1,this.showManaBar(s,a,r,p)),g.helper.monster.sign&&this.showNearSignHelper(s,a,r)}}class ve extends dt{constructor(e,t){super(e,t),this.id=t??ht("fmst"),this.flyable()}}class Ae{constructor(e,t="none",s,i){n(this,"id");n(this,"name");n(this,"stat");n(this,"position",null);n(this,"dropped",!1);n(this,"price");n(this,"level");n(this,"wearPosition");n(this,"shootingSpeed",2);n(this,"locate");n(this,"nearSign",!1);n(this,"unitTemp",null);n(this,"delayQueue",[]);n(this,"color");n(this,"nameColor");n(this,"size");n(this,"state");n(this,"attackDist");n(this,"offDist");n(this,"shootingable",!1);n(this,"attackDelay",ot.VELOCITY.UNIT.ATTACK);n(this,"dist");n(this,"imageScale",1);n(this,"currentAnimation");n(this,"currentAnimationIndex",0);n(this,"currentShootAnimation");n(this,"currentShootAnimationIndex",0);n(this,"frame",0);n(this,"frameDir",!0);n(this,"fps",60);n(this,"frameRate",.2);this.id=ht("it"),this.name=e,this.price=s??0,this.level=i??0,this.setImageScale(1),this.setAttackDelay(ot.VELOCITY.UNIT.ATTACK),this.setCurrentAnimation(S.Object.None),this.setSize(ct({x:x.ITEM.X,y:x.ITEM.Y})),this.setState(D.Walking),this.setLocate(g.defaultSpawn),this.setStat(at({str:0,dex:0,int:0,luck:0})),this.setWearPosition(t),this.disshootable(),this.setAttackDistance(Q.DEFAULT.ITEM.ATTACK_DIST),this.setAroundDistance(Q.DEFAULT.ITEM.AROUND_DIST),this.setColor(f.Name.Normal),this.setNameColor(f.Name.Normal)}setOffDist(e){this.offDist=e*d.SCALE}setShootingSpeed(e){this.shootingSpeed=e}shootable(){this.shootingable=!0}disshootable(){this.shootingable=!1}setStat(e){this.stat=at(e)}setSize(e,t){typeof e=="number"?this.size=ct({x:e,y:t}):this.size=ct(e)}setAttackDelay(e){this.attackDelay=e}setImageScale(e){this.imageScale=e}setCurrentAnimationIndex(e){this.currentAnimationIndex=e}setCurrentAnimation(e){this.currentAnimation=e}setCurrentShootAnimationIndex(e){this.currentShootAnimationIndex=e}setCurrentShootAnimation(e){this.currentShootAnimation=e}getCurrentAnimationSrc(){var e;return(((e=this.currentAnimation)==null?void 0:e.src)||S.Object.None.src).replace(location.origin,"")}setNameColor(e){this.nameColor=e}setColor(e){this.color=e}setAttackDistance(e){this.attackDist=e}setAroundDistance(e){this.dist=e}setState(e){this.state=e}setLocate(e){this.locate=e}setPosition(e,t){typeof e=="number"?this.position=tt({x:e,y:t}):this.position=tt(e)}setWearPosition(e){this.wearPosition=e}setStr(e){this.stat.str=e}setDex(e){this.stat.dex=e}setInt(e){this.stat.int=e}setLuck(e){this.stat.luck=e}around(e){const t=this.dist+this.size.x,s=Math.abs(this.position.x+this.size.x/2-(e.position.x+e.size.x/2)),i=Math.abs(this.position.y+this.size.y/2-(e.position.y+e.size.y/2));return Math.sqrt(s**2+i**2)<t?(this.nearSign=!0,this.unitTemp===null&&(this.unitTemp=e)):(this.nearSign=!1,this.unitTemp=null),this.nearSign}showAroundBoudary(e,t,s){const i=this.dist+this.size.x;this.nearSign?(e.strokeStyle=f.Sign.Near,e.fillStyle=f.Sign.Near+"56"):(e.strokeStyle=f.Sign.Dark+"56",e.fillStyle=f.Sign.None+"56"),e.beginPath(),e.arc(this.position.x+this.size.x/2+t,this.position.y+this.size.y/2+s,i-this.size.x/2,0,Math.PI*2),e.stroke(),e.fill()}showSignHelper(e,t,s){this.nearSign&&(e.textAlign="center",e.lineWidth=2,e.strokeStyle=f.Sign.White,e.fillStyle=f.Sign.Info,e.font=`bold ${32*d.SCALE}px sans-serif`,e.strokeText("?",this.position.x+t+this.size.x/2,this.position.y+s-this.size.y+this.size.y*this.imageScale/4),e.fillText("?",this.position.x+t+this.size.x/2,this.position.y+s-this.size.y+this.size.y*this.imageScale/4),e.lineWidth=1)}draw(e,t,s,i){const[o,a]=rt(this.size);if(g.helper.item.boundary.around&&this.showAroundBoudary(e,o,a),this.currentAnimation){const r=this.fps*this.frameRate;this.frame=this.frame+(this.frameDir?1:-1)*1,this.currentAnimationIndex=Math.round(this.frame/r),(this.frame===r*2||this.frame===0)&&(this.frameDir=!this.frameDir),e.fillStyle=this.color;const l=this.state===D.Walking?this.currentAnimationIndex:1;e.drawImage(this.currentAnimation,32*l,0,32,32,this.position.x+o-this.size.x/2*(this.imageScale-1)/2,this.position.y+a-this.size.y/2*(this.imageScale-1)/2,this.size.x*this.imageScale,this.size.y*this.imageScale)}else e.fillStyle=this.color,e.beginPath(),e.arc(this.position.x+o+this.size.x/2,this.position.y+a+this.size.y/2,this.size.x/2*this.imageScale/2,0,Math.PI*2),e.fill();g.display.item.name&&(e.fillStyle=this.nameColor,e.font=`bold ${12*d.SCALE}px san-serif`,e.textAlign="center",e.fillText(this.name,this.position.x+o+this.size.x/2,this.position.y+a-this.size.y/5)),g.helper.item.sign&&this.showSignHelper(t,o,a)}}function Rt(h,e,t,s){const i=new Ae(h);return e&&i.setStat(e),t&&i.setWearPosition(t),s!=null&&s.shootable&&i.shootable(),s!=null&&s.offDist&&i.setOffDist(s.offDist),s!=null&&s.attackDist&&i.setAttackDistance(s.attackDist),s!=null&&s.currentAnimation&&i.setCurrentAnimation(s.currentAnimation),s!=null&&s.currentShootAnimation&&i.setCurrentShootAnimation(s.currentShootAnimation),s!=null&&s.delay&&i.setAttackDelay(s.delay),s!=null&&s.shootSpeed&&i.setShootingSpeed(s.shootSpeed),function(a,r,l){return r&&i.setStat(r),a&&i.setWearPosition(a),l!=null&&l.shootable&&i.shootable(),l!=null&&l.offDist&&i.setOffDist(l.offDist),l!=null&&l.attackDist&&i.setAttackDistance(l.attackDist),i.currentAnimation===null&&i.setCurrentAnimation((l==null?void 0:l.currentAnimation)||null),i.currentShootAnimation===null&&i.setCurrentShootAnimation((l==null?void 0:l.currentShootAnimation)||null),l!=null&&l.delay&&i.setAttackDelay(s.delay),l!=null&&l.shootSpeed&&i.setShootingSpeed(s.shootSpeed),i}}let Vt={EmptyItem:Rt("empty"),SwordItem:Rt("sword",at({str:3,dex:1,int:0,luck:1}),"weapon",{currentAnimation:S.Object.Item.Sword}),GunItem:Rt("gun",at({str:3,dex:1,int:0,luck:1}),"weapon",{shootable:!0,attackDist:150,offDist:200,delay:.2,shootSpeed:5,currentAnimation:S.Object.Item.Gun,currentShootAnimation:null}),BananaItem:Rt("banana",at({str:50,dex:1,int:0,luck:1}),"weapon",{shootable:!0,attackDist:150,offDist:200,delay:1,shootSpeed:2,currentAnimation:S.Object.Item.Banana,currentShootAnimation:S.Object.Item.Banana})};Vt=new Proxy(Vt,{get(h,e,t){return Reflect.get(h,e,t)}});const it=Vt;class Ls{constructor(){n(this,"logger");n(this,"ownerStat");n(this,"owner");n(this,"head",it.EmptyItem("head"));n(this,"top",it.EmptyItem("top"));n(this,"bottom",it.EmptyItem("bottom"));n(this,"hand",it.EmptyItem("hand"));n(this,"foot",it.EmptyItem("foot"));n(this,"weapon",it.EmptyItem("weapon"));n(this,"guard",it.EmptyItem("guard"));n(this,"ring",it.EmptyItem("ring"));n(this,"opened",!1);this.logger=new nt(this),this.logger.fixed.loaded()}getTotalByStatType(e){return this.head.stat[e]+this.top.stat[e]+this.bottom.stat[e]+this.hand.stat[e]+this.foot.stat[e]+this.weapon.stat[e]+this.guard.stat[e]+this.ring.stat[e]}isAlreadyEquipped(e){return this[e].name!=="empty"}getItemBy(e){switch(e){case this.head.id:return this.head;case this.top.id:return this.top;case this.bottom.id:return this.bottom;case this.hand.id:return this.hand;case this.foot.id:return this.foot;case this.weapon.id:return this.weapon;case this.guard.id:return this.guard;case this.ring.id:return this.ring;default:return null}}setOwner(e){this.owner=e,this.ownerStat=at(e.stat)}setOpen(){this.opened=!0}setClose(){this.opened=!1}putOn(e){var t;((t=this[e.wearPosition])==null?void 0:t.name)!=="empty"&&this.owner&&this.takeOff(e.wearPosition),e.shootingable&&this.owner.shootable(),e.attackDist&&this.owner.setAttackDistance(e.attackDist),e.attackDelay&&(this.owner.velocity.attack=e.attackDelay),this[e.wearPosition]=e}takeOff(e){const t=this[e];return t.shootingable&&this.owner.disshootable(),t.attackDist&&this.owner.setAttackDistance(Q.DEFAULT.UNIT.ATTACK_DIST),t.attackDelay&&(this.owner.velocity.attack=ot.VELOCITY.UNIT.ATTACK),this[e]=it.EmptyItem(e),t}}class zs{constructor(){n(this,"logger");n(this,"name");n(this,"bagSize",{x:5,y:3});n(this,"bags");n(this,"owner");n(this,"opened",!1);this.logger=new nt(this),this.logger.fixed.loaded(),this.setupBags()}getItemBy(e){return this.bags.flat(1).find(t=>t.id===e)}setupBags(){this.bags=[...new Array(this.bagSize.y)].map(()=>[...new Array(this.bagSize.x)].map(()=>it.EmptyItem()))}setOpen(){this.opened=!0}setClose(){this.opened=!1}setOwner(e){this.owner=e,this.logger.debug("아이템 소유자:",e)}dropItem(e){const t=[0,0];let s;for(const i in this.bags){for(const o in this.bags[i])if(s=this.bags[i][o],s.id===e){t[0]=+o,t[1]=+i;break}if(t[0]!==void 0&&t[1]!==void 0)break}if(s){this.logger.debug(t);const[i]=this.bags[t[1]].splice(t[0],1,new Ae("empty"));return i.setLocate(this.owner.locate),i.setPosition(this.owner.position),i.dropped=!0,i}return this.sorting(),null}addItem(e){for(const t of this.bags){const s=t.findIndex(i=>i.name==="empty");if(s>-1){t.splice(s,1),t.splice(s,0,e),e.dropped=!1;break}}H.splice(H.indexOf("take-item"),1),this.sorting()}sorting(){const t=this.bags.flat(1).filter(i=>i.name!=="empty"),s=[];for(let i=0;i<this.bagSize.y;i++){s.push([]);const o=s[i];for(let a=0;a<this.bagSize.x;a++)t.length>0?o.push(t.shift()):o.push(it.EmptyItem())}this.bags=s}putOn(e){this.owner.equipment.putOn(e),this.owner.inventory.sorting()}takeOff(e){this.owner.inventory.sorting()}}class te extends dt{constructor(t,s){const i=at({str:7,dex:5,int:5,luck:5});super(t,s);n(this,"shootInterval");n(this,"currentShootAnimation");n(this,"currentShootAnimationIndex",0);this.id=s??ht("stmst"),this.setStat(i),this.shootable(),this.setAroundDistance(150)}setCurrentShootAnimationIndex(t){this.currentShootAnimationIndex=t}setCurrentShootAnimation(t){this.currentShootAnimation=t}die(){super.die(),clearInterval(this.shootInterval)}shootingAttack(t,s,i){if(this.shootingable)if(this.aroundFollowTmp.length===0){clearInterval(this.shootInterval),this.shootInterval=void 0;return}else this.shootInterval===void 0&&t.health>0&&(this.shootAttack(t,s,i),this.shootingInterval(t,s,i))}shootAttack(t,s,i){if(this.state===D.Dead)return;const o=new be({...this.position},{...t.position});o.setCurrentAnimation(this.currentShootAnimation),o.setState(D.Walking),o.setLocate(this.locate),o.setMapManager(i),o.parent=this,i.shootingObjects.set(o.id,o)}shootingInterval(t,s,i){this.shootInterval=setInterval(this.shootAttack.bind(this,t,s,i),this.velocity.attack*1e3)}aroundAttack(t,s,i){super.aroundAttack(t,s),this.shootingAttack(t,s,i)}}class be extends dt{constructor(t,s){const i=ht("obj");super(i,i.split("-")[1]);n(this,"parent");n(this,"objSize",5*d.SCALE);n(this,"offDist",200*d.SCALE);n(this,"shootingSpeed",2);n(this,"startPosition");n(this,"targetPosition");n(this,"mapManager");n(this,"shootAngle",0);this.id="stobj"+i,this.startPosition=t,this.targetPosition=s,this.setPosition(t.x,t.y),this.setAroundDistance(this.objSize/2-this.size.x/2),this.setAttackDistance(this.objSize/2-this.size.y/2),this.flyable()}setOffDist(t){this.offDist=t*d.SCALE}setShootAngle(t){this.shootAngle=t}move(){const t=this.startPosition.x<this.targetPosition.x?1:-1,s=this.startPosition.y<this.targetPosition.y?1:-1,i=Math.abs(this.startPosition.x-this.targetPosition.x),o=Math.abs(this.startPosition.y-this.targetPosition.y),a=Math.sqrt(i**2+o**2);super.move(t*(i/a)*this.shootingSpeed,s*(o/a)*this.shootingSpeed)}attack(t){let s=this.parent.stat.str,i=this.parent.stat.dex;this.parent instanceof xt&&(s+=this.parent.equipment.getTotalByStatType("str"),i+=this.parent.equipment.getTotalByStatType("dex")),this.stat.str=s,this.stat.dex=i,this.hitColors=this.parent.hitColors,this.level=this.parent.level,super.attack(t),this.die(),t instanceof dt&&this.parent instanceof xt&&t.health<=0&&(t instanceof te&&(clearInterval(t.shootInterval),t.shootInterval=void 0),this.parent.addMoney(t.dropMoney),this.parent.addExp(t.dropExp)),this.mapManager.shootingObjects.delete(this.id)}die(){this.delayQueue=this.delayQueue.filter(t=>t!=="shooting"),this.delayQueue=this.delayQueue.filter(t=>t!=="attack"),this.setState(D.Dead),this.nearSign=!1,this.velocity.speed=0,this.lockMove(1.5),this.logger.info(this.delayQueue),this.stopTrace()}attackTarget(t,s){for(const i of this.aroundPlayerTmp){const o=this.attackDist+this.size.x,a=Math.abs(this.position.x+this.size.x/2-(i.position.x+i.size.x/2)),r=Math.abs(this.position.y+this.size.y/2-(i.position.y+i.size.y/2));Math.sqrt(a**2+r**2)<o&&(this.attack(i),g.mode==="multi"&&(this.parent instanceof dt?s.send(JSON.stringify({type:"sync/player/info",id:i.id,health:i.health,mana:i.mana,maxHealth:i.maxHealth,maxMana:i.maxMana})):this.parent instanceof xt&&s.send(JSON.stringify({type:"sync/monster/info",id:i.id,health:i.health,mana:i.mana,maxHealth:i.maxHealth,maxMana:i.maxMana}))))}}aroundAttack(t,s){if(this.aroundFollowTmp.length===0){this.attackInterval=void 0;return}else this.attackInterval===void 0&&this.aroundPlayerTmp.length>0&&this.attackTarget(t,s)}setMapManager(t){this.mapManager=t}setShootingSpeed(t){this.shootingSpeed=t}draw(t,s,i,o){const[a,r]=rt(this.size);if(g.helper.shootObject.boundary.attack&&this.showAttackBoundaryHelper(t,a,r),g.helper.shootObject.boundary.around&&this.showAroundBoundaryHelper(t,a,r),this.currentAnimation){const u=this.fps*this.frameRate;this.frame=this.frame+(this.frameDir?1:-1)*1,this.currentAnimationIndex=Math.round(this.frame/u),(this.frame===u*2||this.frame===0)&&(this.frameDir=!this.frameDir),t.fillStyle=this.color;const w=this.state===D.Walking?this.currentAnimationIndex:1,k=this.position.x+a-this.size.x/2*(this.imageScale-1)/2,E=this.position.y+r-this.size.y/2*(this.imageScale-1)/2;t.save(),t.drawImage(this.currentAnimation,this.size.x*w,0,this.size.x,this.size.y,k,E,this.size.x*this.imageScale,this.size.y*this.imageScale),t.restore()}else t.fillStyle=this.color,t.beginPath(),t.arc(this.position.x+a+this.size.x/2,this.position.y+r+this.size.y/2,this.objSize,0,Math.PI*2),t.fill();const l=g.display.shootObject.name,y=g.display.shootObject.health,c=g.display.shootObject.mana;let p=Number(l)+Number(y)+Number(c);l&&(p-=1,this.showName(t,a,r,p)),y&&(p-=1,this.showHealthBar(t,a,r,p)),c&&(p-=1,this.showManaBar(t,a,r,p)),g.helper.shootObject.sign&&this.showNearSignHelper(t,a,r)}}class xt extends Zt{constructor(t,s){const i=at({str:15,dex:5,int:5,luck:5});super(t,s);n(this,"equipment");n(this,"inventory");n(this,"money",0);n(this,"aroundMonsterTmp",null);n(this,"events",{});this.setStat(i),this.initialHealthMana(Q.DEFAULT.UNIT.HEALTH,Q.DEFAULT.UNIT.MANA),this.createInventory(),this.createEquipment()}on(t,s){t in this.events||(this.events[t]=[]),this.events[t].push(s)}setAttackDistance(t=Q.DEFAULT.UNIT.ATTACK_DIST){this.attackDist=t}addMoney(t){this.money+=t,this.events.money.forEach(s=>s())}dropMoney(t){const s=this.money-t;this.money=s>0?s:0,this.events.money.forEach(i=>i())}aroundAttackableMonster(t){const s=this.attackDist+this.size.x;this.nearSign=t.some(i=>{const o=Math.abs(this.position.x+this.size.x/2-(i.position.x+i.size.x/2)),a=Math.abs(this.position.y+this.size.y/2-(i.position.y+i.size.y/2));return Math.sqrt(o**2+a**2)<s}),this.aroundMonsterTmp=t.filter(i=>{const o=Math.abs(this.position.x+this.size.x/2-(i.position.x+i.size.x/2)),a=Math.abs(this.position.y+this.size.y/2-(i.position.y+i.size.y/2)),l=Math.sqrt(o**2+a**2)<s,y=i.health>0;return l&&y})}attack(t){if(this.state===D.Dead)return;const s=this.calculateUnitDamage(),i=Math.floor(this.stat.dex*Math.random()),o=t.health-(s+i);t&&(this.logger.log("hit mob:",t.name,`
damage:`,s+i),o<=0?(this.logger.info("unit dead."),t.health=0,this.addMoney(t.dropMoney),this.addExp(t.dropExp),t.die()):t.health=o),ke((s+i).toString(),t,1,this.hitColors).run()}shootAttack(t,s,i){if(this.state===D.Dead)return;const o=new be({...this.position},{...t.position});o.setCurrentAnimation(this.equipment.weapon.currentShootAnimation),o.setState(D.Walking),o.setMapManager(i),o.setShootingSpeed(this.equipment.weapon.shootingSpeed||2),o.setShootAngle(Math.atan2(t.position.y-this.position.y,t.position.x-this.position.x)),o.setLocate(this.locate),o.parent=this,this.equipment.weapon.name!=="empty"&&(o.offDist=this.equipment.weapon.offDist),i.shootingObjects.set(o.id,o)}aroundAttack(t,s){var o;if(this.delayQueue.includes("attack"))return;this.delayQueue.push("attack");const i=(o=this.aroundMonsterTmp)==null?void 0:o.reduce((a,r)=>{if(a===null)return r;{const l=this.attackDist+this.size.x,y=Math.abs(this.position.x+this.size.x/2-(r.position.x+r.size.x/2)),c=Math.abs(this.position.y+this.size.y/2-(r.position.y+r.size.y/2)),p=Math.sqrt(y**2+c**2),u=Math.abs(this.position.x+this.size.x/2-(a.position.x+a.size.x/2)),w=Math.abs(this.position.y+this.size.y/2-(a.position.y+a.size.y/2)),k=Math.sqrt(u**2+w**2);return p<k&&(p<l||k<l)?r:a}},null);i&&(this.shootingable?this.shootAttack(i,s,t):(this.attack(i),g.mode==="multi"&&s.send(JSON.stringify({type:"sync/monster/info",id:i.id,health:i.health,mana:i.mana,maxHealth:i.maxHealth,maxMana:i.maxMana})))),setTimeout(()=>{this.delayQueue.splice(this.delayQueue.indexOf("attack"),1)},this.velocity.attack*1e3)}createEquipment(){this.equipment=new Ls,this.equipment.setOwner(this)}openEquipment(){return this.equipment.setOpen(),this.equipment}closeEquipment(){this.equipment.setClose()}createInventory(){this.inventory=new zs,this.inventory.setOwner(this)}reloadInventory(){this.closeInventory(),this.openInventory()}openInventory(){return this.inventory.setOpen(),this.inventory}closeInventory(){this.inventory.setClose()}totalCalculateUnitDamage(){const t=super.calculateUnitDamage(),s=this.equipment.getTotalByStatType("str");return t+s}showAttackBoundaryHelper(t,s,i){var r;const o=this.attackDist+this.size.x;((r=this.aroundMonsterTmp)==null?void 0:r.reduce((l,y)=>{if(l===null)return y;{const c=this.attackDist+this.size.x,p=Math.abs(this.position.x+this.size.x/2-(y.position.x+y.size.x/2)),u=Math.abs(this.position.y+this.size.y/2-(y.position.y+y.size.y/2)),w=Math.sqrt(p**2+u**2),k=Math.abs(this.position.x+this.size.x/2-(l.position.x+l.size.x/2)),E=Math.abs(this.position.y+this.size.y/2-(l.position.y+l.size.y/2)),z=Math.sqrt(k**2+E**2);return w<z&&(w<c||z<c)?y:l}},null))||this.nearSign?(t.strokeStyle=f.Sign.Attackable,t.fillStyle=f.Sign.Attackable+"56"):(t.strokeStyle="#00000056",t.fillStyle="#ffffff26"),t.beginPath(),t.arc(this.position.x+this.size.x/2+s,this.position.y+this.size.y/2+i,o-this.size.x/2,0,Math.PI*2),t.stroke(),t.fill()}draw(t,s,i,o){const[a,r]=rt(this.size);g.helper.player.boundary.attack&&this.showAttackBoundaryHelper(t,a,r),super.draw(t,s,i,o);const l=g.display.player.name,y=g.display.player.health,c=g.display.player.mana;let p=Number(l)+Number(y)+Number(c);l&&(p-=1,this.showName(s,a,r,p)),y&&(p-=1,this.showHealthBar(s,a,r,p)),c&&(p-=1,this.showManaBar(s,a,r,p))}}function Ds(h,e){const t=new ve("dragonfly",e);return h?t.setPosition(h.x,h.y):t.setPosition(50,50),t.level=2,t.stat.str=5,t.initialHealthMana(50,10),t.setMoveSpeed(.5,.01),t.setAttackDelay(3),t.setAroundDistance(50),t}function It(h,e){const t=new dt("slime"+It.id,e);return It.id+=1,h?t.setPositionByIndex(h.x,h.y):t.setPositionByIndex(1,1),t.stat.str=5,t.setMoveSpeed(.5,.01),t.setAttackDelay(3),t.setAroundDistance(50),t.setDropMoney(5),t.setDropExp(10),t}It.id=1;class ee{constructor(){n(this,"logger");n(this,"userId",ht("ut"));n(this,"socket");n(this,"connectResolver",()=>{});n(this,"controlUser",null);n(this,"mapManager");this.logger=new nt(ee.name),this.logger.fixed.loaded(),this.logger.debug("소켓 생성, 연결 중...")}setup(){this.logger.debug("소켓 초기화");const e=new WebSocket(Es+`?id=${this.userId}`);e.binaryType="arraybuffer",e.onopen=this.handleOpen.bind(this),e.onclose=this.handleClose.bind(this),e.onmessage=this.handleMessage.bind(this),this.socket=e}setMapManager(e){this.mapManager=e,this.logger.debug("맵 매니저 등록")}setControlUser(e){this.controlUser=e}initialGuest(){this.socket.send(JSON.stringify({type:"join/guest",id:this.controlUser.id,name:this.controlUser.name}))}socketReady(){return new Promise((e,t)=>{this.connectResolver=e})}handleOpen(e){this.logger.debug("소켓 열림, 연결 완료!"),this.connectResolver(!0)}handleClose(e){this.logger.debug("소켓 닫힘")}handleMessage(e){const{data:t}=e,s=JSON.parse(t);switch(s.type){case"list/unit":{s.units.forEach(i=>{const o=new xt(i.name,i.id);o.setPosition(i.x??mt.INIT.x,i.y??mt.INIT.y),o.setLocate(i.locate??g.defaultSpawn),this.mapManager.addUnit(o)});break}case"list/monster":{s.monsters.forEach(i=>{switch(i.name){case"slime":{const o=It({x:i.x,y:i.y},i.id);o.setPosition(i.x??mt.INIT.x,i.y??mt.INIT.y),o.setLocate(i.locate??g.defaultSpawn),this.mapManager.addMonster(o),this.socket.send(JSON.stringify({type:"sync/monster/info",id:o.id,health:o.health,mana:o.mana,maxHealth:o.maxHealth,maxMana:o.maxMana}));break}case"dragonfly":{const o=Ds({x:i.x,y:i.y},i.id);o.setPosition(i.x??mt.INIT.x,i.y??mt.INIT.y),o.setLocate(i.locate??g.defaultSpawn),this.mapManager.addMonster(o),this.socket.send(JSON.stringify({type:"sync/monster/info",id:o.id,health:o.health,mana:o.mana,maxHealth:o.maxHealth,maxMana:o.maxMana}));break}}});break}case"sync/player/info":{const i=this.mapManager.users.get(s.id);i&&(i.health=s.health,i.mana=s.mana,i.maxHealth=s.maxHealth,i.maxMana=s.maxMana),this.mapManager.users.set(s.id,i);break}case"sync/monster/info":{const i=this.mapManager.monsters.get(s.id);i&&(i.health=s.health,i.mana=s.mana,i.maxHealth=s.maxHealth,i.maxMana=s.maxMana),this.mapManager.monsters.set(s.id,i);break}case"join/guest":{if(!this.controlUser||s.id!==this.controlUser.id){const i=new xt(s.name,s.id);this.mapManager.addUnit(i)}break}case"join/monster":{const i=s.mtype==="Monster"?new dt(s.name,s.id):new ve(s.name,s.id);i.setPosition(s.x,s.y),i.initialHealthMana(s.health,s.mana),this.mapManager.addMonsterAt(i,s.locate);break}case"out/guest":{this.mapManager.deleteUnit(s.id);break}case"change/locate":{if(s.id!==this.controlUser.id){const i=this.mapManager.users.get(s.id);i.setLocate(s.locate),i.setPosition(s.x,s.y),this.mapManager.users.set(s.id,i)}break}case"move":{const i=this.mapManager.users.get(s.id);i&&(i.position.x=s.x,i.position.y=s.y);break}case"move/monster":{const i=this.mapManager.monsters.get(s.id);this.logger.log("몬스터 이동",i),i&&(i.position.x=s.x,i.position.y=s.y);break}}}}class Ns{constructor(){n(this,"logger");n(this,"version",Qe.version);n(this,"mapManager");n(this,"eventManager");n(this,"ui");n(this,"socket");n(this,"spawnLocate",g.defaultSpawn);n(this,"options",{...g});this.logger=new nt(this),this.logger.fixed.loaded()}defaultSpawnLocate(e){this.spawnLocate=e,this.mapManager.defaultSpawnLocate(e),this.mapManager.setGameField(Z.getMap(e))}setOption(e){Object.assign(this.options,e),Object.assign(g,e)}setup({eventManager:e,mapManager:t,ui:s}){this.setupEventManager(e),this.setupMapManager(t),this.setupUI(s)}setupEventManager(e){this.eventManager=e,this.setupSocket()}setupSocket(){this.socket=new ee,g.mode==="multi"&&this.socket.setup(),this.eventManager.setProxySocket(this.socket)}setupMapManager(e){this.mapManager=e,this.mapManager.minimapOptions=this.options.minimap,this.socket.setMapManager(e),this.eventManager.setMapManager(this.mapManager),this.mapManager.proxyJoystick=this.eventManager.joystick,this.mapManager.setProxySocket(this.socket)}setupUI(e){this.ui=e,this.eventManager.ui=this.ui,this.mapManager.ui=this.ui,this.ui.showVersion(this.version),this.eventManager.setup(),this.mapManager.setup()}run(){this.mapManager.run(),this.logger.error("미등록 객체",Dt.filter(e=>!("isLoaded"in e)).map(e=>{const[t]=Object.entries(L).find(i=>i[1]===e.locate),s=Dt.find(i=>{if(i instanceof Ct)return i.forwardField.name===L[t]});return e.constructor.name+":"+e.name+`${e instanceof Ct?"<-"+s.name:""}`}))}}function Cs({text:h,mob:e,duration:t,color:s}){let i=-e.size.y;const o=new we("levelupEffect"),a=innerWidth/2,r=innerHeight/2;return o.fadeInDuration=.5,o.fadeOutDuration=.5,o.duration=t||1,o.renderFx=(l,y,c,p)=>{const u="ff",w=l.measureText(h);if(l.textAlign="center",l.lineWidth=2,l.strokeStyle=f.Sign.White,l.font=`bold ${32*d.SCALE}px sans-serif`,Array.isArray(s)){const k=l.createLinearGradient(e.position.x+a-d.VIEW.x,e.position.y+r-d.VIEW.y-e.size.y-w.fontBoundingBoxAscent*1.5-i,e.position.x+a-d.VIEW.x,e.position.y+r-d.VIEW.y-e.size.y-w.fontBoundingBoxAscent/2-i);s.forEach((E,z)=>{k.addColorStop(z/s.length,E+u)}),l.fillStyle=k}else l.fillStyle=s??"green";l.strokeText(h,e.position.x+a-d.VIEW.x,e.position.y+r-d.VIEW.y-e.size.y-w.fontBoundingBoxAscent-i),l.fillText(h,e.position.x+a-d.VIEW.x,e.position.y+r-d.VIEW.y-e.size.y-w.fontBoundingBoxAscent-i),i+=.5,l.lineWidth=1},o}class Ps{constructor(){n(this,"logger");n(this,"proxySocket");n(this,"globalRespawnQueue",[]);n(this,"order",[]);n(this,"joystick",{w:!1,s:!1,a:!1,d:!1,z:!1,space:!1});n(this,"mobJoystick",{w:!1,s:!1,a:!1,d:!1,z:!1,space:!1,touch:!1,ball:null,boundary:null});n(this,"mapManager");n(this,"ui");n(this,"spawnLocate");n(this,"dragging",null);n(this,"dragX",null);n(this,"dragY",null);n(this,"dragCenterX",innerWidth);n(this,"dragCenterY",innerHeight);n(this,"handleDownBtnHandler");n(this,"handleDownHandler");n(this,"handleUpEvent");n(this,"hadleMoveEvent");this.logger=new nt(this)}setup(){window.addEventListener("mousemove",this.handleDragging.bind(this)),window.addEventListener("dragstart",this.handleDragStart.bind(this)),window.addEventListener("keydown",this.handleKeydown.bind(this)),window.addEventListener("keyup",this.handleKeyup.bind(this)),window.addEventListener("click",this.handleClick.bind(this)),window.addEventListener("contextmenu",this.handleRightClick.bind(this)),this.handleDownBtnHandler=this.handleActionMouseDown.bind(this),this.handleDownHandler=this.handleJoyStickMouseDown.bind(this),this.handleUpEvent=this.handleJoyStickMouseUp.bind(this),this.hadleMoveEvent=this.handleJoyStickMouseMove.bind(this),window.addEventListener("pointerdown",e=>{const t=e.target,s=t.closest(".inventory")||t.closest(".equipment");s&&(this.dragging=s,this.dragX=e.clientX,this.dragY=e.clientY)}),window.addEventListener("pointermove",this.handleDragging.bind(this)),this.setupBroker(),this.setupMobileJoystick()}clearJoystick(){this.joystick.w=!1,this.joystick.s=!1,this.joystick.a=!1,this.joystick.d=!1,this.mobJoystick.touch=!1,this.mobJoystick.ball=null,this.mobJoystick.boundary=null,this.proxySocket.controlUser&&!this.joystick.w&&!this.joystick.s&&!this.joystick.a&&!this.joystick.d&&(this.proxySocket.controlUser.state=D.Hold,this.proxySocket.controlUser.currentAnimationIndex=1,this.proxySocket.controlUser.frame=1,this.proxySocket.controlUser.frameDir=!0)}handleActionMouseDown(e){var s,i,o,a;if(H.includes("forward"))return;if(U.length>0){this.clearJoystick();return}const t=e.target;t.closest("#action-btn")&&(s=this.proxySocket)!=null&&s.controlUser&&(((i=this.proxySocket.controlUser.aroundMonsterTmp)==null?void 0:i.length)>0?this.proxySocket.controlUser.aroundAttack(this.mapManager,this.proxySocket.socket):(this.joystick.space=!0,setTimeout(()=>{this.joystick.space=!1},0))),t.closest("#inven-btn")&&(o=this.proxySocket)!=null&&o.controlUser&&(this.proxySocket.controlUser.inventory.opened?this.ui.closeInventory(this.proxySocket.controlUser):this.ui.openInventory(this.proxySocket.controlUser)),t.closest("#equip-btn")&&(a=this.proxySocket)!=null&&a.controlUser&&(this.proxySocket.controlUser.equipment.opened?this.ui.closeEquipment(this.proxySocket.controlUser):this.ui.openEquipment(this.proxySocket.controlUser))}handleJoyStickMouseDown(e){var o;if(H.includes("forward"))return;if(U.length>0){this.clearJoystick();return}const t=e.target,s=t.closest("#ball")||t.querySelector("#ball")||((o=t.parentElement)==null?void 0:o.querySelector("#ball")),i=t.closest("#mobile-joystick");i&&(this.mobJoystick.touch=!0,this.mobJoystick.ball=s,this.mobJoystick.boundary=i)}handleJoyStickMouseUp(e){var i;if(H.includes("forward"))return;if(U.length>0){this.clearJoystick();return}const t=e.target,s=this.mobJoystick.ball;s&&(s.style.transform="translate(-50%, -50%)"),this.mobJoystick.touch&&(this.clearJoystick(),this.order.splice(0)),t.closest("#action-btn")&&(i=this.proxySocket)!=null&&i.controlUser&&(this.joystick.space=!1)}handleJoyStickMouseMove(e){var t,s,i,o,a,r,l,y,c,p,u,w,k;if(!H.includes("forward")){if(U.length>0){this.clearJoystick();return}if(this.mobJoystick.touch){const E=(t=this.mobJoystick.boundary)==null?void 0:t.getBoundingClientRect(),z=E.width/2,X=E.height/2,F=E.left,J=E.top,G=X+J,_=z+F,m=e.clientX,N=e.clientY,C=m-_,Y=N-G,R=parseInt(C.toString()),P=parseInt(Y.toString()),B=Math.sqrt(R**2+P**2),v=50,W=Math.atan2(R,P),M=parseInt((W/Math.PI*10*18+180).toString());this.proxySocket.controlUser&&!this.proxySocket.controlUser.delayQueue.includes("move")&&(this.proxySocket.controlUser.state=D.Walking),M<60&&M>30?(this.joystick.w=!0,this.joystick.a=!0,this.joystick.s=!1,this.joystick.d=!1,this.order.includes("w")||this.order.push("w"),this.order.includes("a")||this.order.push("a"),(s=this.proxySocket.controlUser)==null||s.setCurrentAnimation(S.Character.Player.Back),(i=this.proxySocket.controlUser)==null||i.setCurrentAnimation(S.Character.Player.Left)):M<30||M>330?(this.joystick.w=!0,this.joystick.a=!1,this.joystick.s=!1,this.joystick.d=!1,this.order.includes("w")||this.order.push("w"),(o=this.proxySocket.controlUser)==null||o.setCurrentAnimation(S.Character.Player.Back)):M<330&&M>300?(this.joystick.w=!0,this.joystick.a=!1,this.joystick.s=!1,this.joystick.d=!0,this.order.includes("w")||this.order.push("w"),this.order.includes("d")||this.order.push("d"),(a=this.proxySocket.controlUser)==null||a.setCurrentAnimation(S.Character.Player.Back),(r=this.proxySocket.controlUser)==null||r.setCurrentAnimation(S.Character.Player.Right)):M<300&&M>240?(this.joystick.w=!1,this.joystick.a=!1,this.joystick.s=!1,this.joystick.d=!0,this.order.includes("d")||this.order.push("d"),(l=this.proxySocket.controlUser)==null||l.setCurrentAnimation(S.Character.Player.Right)):M<240&&M>210?(this.joystick.w=!1,this.joystick.a=!1,this.joystick.s=!0,this.joystick.d=!0,this.order.includes("d")||this.order.push("d"),this.order.includes("s")||this.order.push("s"),(y=this.proxySocket.controlUser)==null||y.setCurrentAnimation(S.Character.Player.Front),(c=this.proxySocket.controlUser)==null||c.setCurrentAnimation(S.Character.Player.Right)):M<210&&M>150?(this.joystick.w=!1,this.joystick.a=!1,this.joystick.s=!0,this.joystick.d=!1,this.order.includes("s")||this.order.push("s"),(p=this.proxySocket.controlUser)==null||p.setCurrentAnimation(S.Character.Player.Front)):M<150&&M>120?(this.joystick.w=!1,this.joystick.s=!0,this.joystick.a=!0,this.joystick.d=!1,this.order.includes("s")||this.order.push("s"),this.order.includes("a")||this.order.push("a"),(u=this.proxySocket.controlUser)==null||u.setCurrentAnimation(S.Character.Player.Front),(w=this.proxySocket.controlUser)==null||w.setCurrentAnimation(S.Character.Player.Left)):M<120&&M>60&&(this.joystick.w=!1,this.joystick.s=!1,this.joystick.a=!0,this.joystick.d=!1,this.order.includes("a")||this.order.push("a"),(k=this.proxySocket.controlUser)==null||k.setCurrentAnimation(S.Character.Player.Left)),this.mobJoystick.boundary.style.transform=`rotate(${-M}deg)`,this.mobJoystick.ball.style.transform=`translate(-50%, ${-((B>v?v:B)/50)*100-50}%)`}}}setupMobileJoystick(){this.ui.setupMobileJoystick(!!this.proxySocket.controlUser)}removeMobileJoystick(){this.ui.removeMobileJoystick()}setupBroker(){this.logger.debug("브로커 구독 초기화");const e=new K("respawn"),t=r=>{this.logger.info("10초 뒤 유닛이 리스폰 됩니다",r),r.reSpawn(10)};e.subscribe(t);const s=new K("level-up-ex"),i=({unit:r})=>{this.logger.log("브로커",r),Cs({text:"Level Up!",duration:2,mob:r,color:[f.Sign.Event,f.Sign.White]}).run()};s.subscribe(i);const o=new K("update-joystick"),a=({agent:r})=>{this.handleJoystickEventManager()};o.subscribe(a)}handleJoystickEventManager(){const e=document.querySelector("#mobile-joystick"),t=document.querySelector("#action-btn"),s=document.querySelector("#inven-btn"),i=document.querySelector("#equip-btn");i.classList.remove("activate"),s.classList.remove("activate"),t.classList.remove("activate"),e.classList.remove("activate"),e.removeEventListener("pointerdown",this.handleDownHandler),e.removeEventListener("pointermove",this.hadleMoveEvent),e.removeEventListener("pointerup",this.handleUpEvent),t.removeEventListener("pointerdown",this.handleDownBtnHandler),s.removeEventListener("pointerdown",this.handleDownBtnHandler),i.removeEventListener("pointerdown",this.handleDownBtnHandler),this.mapManager.currentAgent==="mobile"&&(e.addEventListener("pointerdown",this.handleDownHandler),e.addEventListener("pointermove",this.hadleMoveEvent),e.addEventListener("pointerup",this.handleUpEvent),t.addEventListener("pointerdown",this.handleDownBtnHandler),s.addEventListener("pointerdown",this.handleDownBtnHandler),i.addEventListener("pointerdown",this.handleDownBtnHandler),this.proxySocket.controlUser&&(t.classList.add("activate"),s.classList.add("activate"),i.classList.add("activate"),e.classList.add("activate")))}setMapManager(e){this.mapManager=e}setProxySocket(e){this.proxySocket=e}handleDragging(e){if(this.dragging){e.preventDefault();const t=this.dragX-e.clientX,s=this.dragY-e.clientY;this.dragX=e.clientX,this.dragY=e.clientY,this.dragging.classList.contains("inventory")?(this.ui.inventoryPlacement.x=this.dragging.offsetLeft-t,this.ui.inventoryPlacement.y=this.dragging.offsetTop-s,this.dragging.style.cssText=`left: ${this.ui.inventoryPlacement.x}px; top: ${this.ui.inventoryPlacement.y}px; cursor: grabbing;`):this.dragging.classList.contains("equipment")&&(this.ui.equipmentPlacement.x=this.dragging.offsetLeft-t,this.ui.equipmentPlacement.y=this.dragging.offsetTop-s,this.dragging.style.cssText=`left: ${this.ui.equipmentPlacement.x}px; top: ${this.ui.equipmentPlacement.y}px; cursor: grabbing;`)}}dragEnd(e){this.dragging.style.cursor="",this.dragging=null,this.dragX=null,this.dragY=null}handleDragStart(e){const t=e.target;if(t.classList.contains("equipment")||t.classList.contains("inventory")){e.preventDefault(),this.dragging=t;const s=this.dragX-e.clientX,i=this.dragY-e.clientY;this.dragX=e.clientX,this.dragY=e.clientY,this.dragging.classList.contains("inventory")?(this.ui.inventoryPlacement.x=this.dragging.offsetLeft-s,this.ui.inventoryPlacement.y=this.dragging.offsetTop-i,this.dragging.style.cssText=`left: ${this.ui.inventoryPlacement.x}px; top: ${this.ui.inventoryPlacement.y}px; cursor: grabbing;`):this.dragging.classList.contains("equipment")&&(this.ui.equipmentPlacement.x=this.dragging.offsetLeft-s,this.ui.equipmentPlacement.y=this.dragging.offsetTop-i,this.dragging.style.cssText=`left: ${this.ui.equipmentPlacement.x}px; top: ${this.ui.equipmentPlacement.y}px; cursor: grabbing;`)}}handleRightClick(e){e.preventDefault();const t=e.target;if(t&&this.proxySocket.controlUser){const s=this.proxySocket.controlUser;if(t.classList.contains("item-cell")){const i=s.inventory.getItemBy(t.dataset.itemId);if(this.logger.debug("아이템",i),!(i.name==="empty")){const a=s.inventory.dropItem(t.dataset.itemId);a.setLocate(s.locate),a.setPosition(s.position),this.mapManager.addDropItem(a),s.equipment.opened&&this.ui.reloadEquipment(s),this.ui.reloadInventory(s)}}else if(t.classList.contains("row-head")||t.classList.contains("row-hand")||t.classList.contains("row-top")||t.classList.contains("row-ring")||t.classList.contains("row-weapon")||t.classList.contains("row-bottom")||t.classList.contains("row-guard")||t.classList.contains("row-foot")){const i=s.equipment.getItemBy(t.dataset.itemId);if(!(i.name==="empty")){const a=s.equipment.takeOff(i.wearPosition);a.setLocate(s.locate),a.setPosition(s.position),this.mapManager.addDropItem(a),s.inventory.opened&&this.ui.reloadInventory(s),this.ui.reloadEquipment(s)}}}}handleClick(e){const t=e.target;if(t){if(t.dataset.type!=="login"){if(t.dataset.type==="guest"){const s=new xt("guest",this.proxySocket.userId);s.syncGlobalPosition(),s.lockMove(.5),s.on("money",()=>{this.proxySocket.controlUser.inventory.opened&&this.ui.reloadInventory(this.proxySocket.controlUser)}),s.inventory.addItem(it.SwordItem()),s.inventory.addItem(it.BananaItem()),s.inventory.addItem(it.GunItem()),s.healing(50),this.proxySocket.setControlUser(s),s.stat.str=5,s.setDefaultSpawnLocate(this.mapManager.spawnLocate),this.mapManager.addUnit(s),this.mapManager.setControlUser(s);const i=this.ui.elements.get("login");this.ui.elements.delete("login"),i.remove(),new K("update-joystick").dispatch({agent:this.mapManager.currentAgent}),new K("exp-update").dispatch({unit:this.proxySocket.controlUser,...this.proxySocket.controlUser.getExpAndPercentage()}),g.mode==="multi"&&this.proxySocket.initialGuest()}}if(t.closest("#story")&&(t.classList.contains("story-next")&&(t.dataset.state==="readed"?this.ui.skipStory():this.ui.nextStory()),t.classList.contains("story-all-skip")&&this.ui.skipStory()),this.proxySocket.controlUser){const s=this.proxySocket.controlUser;if(t.classList.contains("inventory-exit"))this.ui.closeInventory(s);else if(t.classList.contains("item-cell")){const i=s.inventory.getItemBy(t.dataset.itemId),o=i.name==="empty",a=s.equipment.isAlreadyEquipped(i.wearPosition);if(o)return;if(a){const r=s.inventory.dropItem(i.id),l=s.equipment.takeOff(i.wearPosition);s.equipment.putOn(r),s.inventory.addItem(l),s.equipment.opened&&this.ui.reloadEquipment(s),this.ui.reloadInventory(s)}else{const r=s.inventory.dropItem(i.id);s.equipment.putOn(r),s.equipment.opened&&this.ui.reloadEquipment(s),this.ui.reloadInventory(s)}}else if(t.classList.contains("row-head")||t.classList.contains("row-hand")||t.classList.contains("row-top")||t.classList.contains("row-ring")||t.classList.contains("row-weapon")||t.classList.contains("row-bottom")||t.classList.contains("row-guard")||t.classList.contains("row-foot")){const i=s.equipment.getItemBy(t.dataset.itemId);if(i&&i.name!=="empty"){const o=s.equipment.takeOff(i.wearPosition);s.inventory.addItem(o),s.inventory.opened&&this.ui.reloadInventory(s),this.ui.reloadEquipment(s)}}if(t.classList.contains("stat-point")){if(this.proxySocket.controlUser.statPoint>0)switch(t.dataset.type){case"str":this.proxySocket.controlUser.stat.str+=1,this.proxySocket.controlUser.statPoint-=1;break;case"dex":this.proxySocket.controlUser.stat.dex+=1,this.proxySocket.controlUser.statPoint-=1;break;case"int":this.proxySocket.controlUser.stat.int+=1,this.proxySocket.controlUser.statPoint-=1;break;case"luck":this.proxySocket.controlUser.stat.luck+=1,this.proxySocket.controlUser.statPoint-=1;break}const{exp:i,maxExp:o,percentage:a}=this.proxySocket.controlUser.getExpAndPercentage();new K("exp-update").dispatch({unit:this.proxySocket.controlUser,exp:i,maxExp:o,percentage:a,statPoint:this.proxySocket.controlUser.statPoint})}if(U.length>0){if(t.classList.contains("question-confirm")){U[0].nextQuestion();return}if(t.classList.contains("question-exit")){U[0].endQuestion();return}}}}this.dragging&&this.dragEnd(e)}popupLogin(){this.ui.login()}handleKeydown(e){var s,i,o,a,r,l,y,c,p,u;const t=e.key;if(!H.includes("forward")){if(U.length>0){t===" "&&U[0].nextQuestion(),t==="Escape"&&U[0].endQuestion();return}if(((s=this.proxySocket.controlUser)==null?void 0:s.state)===D.Dead){this.clearKey();return}t.match(/[wsad]/)&&(this.proxySocket.controlUser&&!this.proxySocket.controlUser.delayQueue.includes("move")&&(this.proxySocket.controlUser.state=D.Walking),t==="w"&&(this.joystick.w=!0,this.order.includes("w")||this.order.push("w"),(i=this.proxySocket.controlUser)==null||i.setCurrentAnimation(S.Character.Player.Back)),t==="s"&&(this.joystick.s=!0,this.order.includes("s")||this.order.push("s"),(o=this.proxySocket.controlUser)==null||o.setCurrentAnimation(S.Character.Player.Front)),t==="a"&&(this.joystick.a=!0,this.order.includes("a")||this.order.push("a"),(a=this.proxySocket.controlUser)==null||a.setCurrentAnimation(S.Character.Player.Left)),t==="d"&&(this.joystick.d=!0,this.order.includes("d")||this.order.push("d"),(r=this.proxySocket.controlUser)==null||r.setCurrentAnimation(S.Character.Player.Right))),t==="Escape"&&this.proxySocket.controlUser&&(this.ui.closeEquipment(this.proxySocket.controlUser),this.ui.closeInventory(this.proxySocket.controlUser)),t==="i"&&((l=this.proxySocket)!=null&&l.controlUser?this.proxySocket.controlUser.inventory.opened?this.ui.closeInventory(this.proxySocket.controlUser):this.ui.openInventory(this.proxySocket.controlUser):this.logger.error("로그인이 필요합니다")),t==="z"&&(y=this.proxySocket)!=null&&y.controlUser&&(this.joystick.z=!0),t==="e"&&((c=this.proxySocket)!=null&&c.controlUser?this.proxySocket.controlUser.equipment.opened?this.ui.closeEquipment(this.proxySocket.controlUser):this.ui.openEquipment(this.proxySocket.controlUser):this.logger.error("로그인이 필요합니다")),t===" "&&(p=this.proxySocket)!=null&&p.controlUser&&(((u=this.proxySocket.controlUser.aroundMonsterTmp)==null?void 0:u.length)>0?this.proxySocket.controlUser.aroundAttack(this.mapManager,this.proxySocket.socket):this.joystick.space=!0)}}handleKeyup(e){var s,i,o,a;const t=e.key;if(t.match(/[wsad]/)){t==="w"&&(this.joystick.w=!1,this.order.splice(this.order.indexOf("w"),1)),t==="s"&&(this.joystick.s=!1,this.order.splice(this.order.indexOf("s"),1)),t==="a"&&(this.joystick.a=!1,this.order.splice(this.order.indexOf("a"),1)),t==="d"&&(this.joystick.d=!1,this.order.splice(this.order.indexOf("d"),1));const r=this.order.at(-1);if(r)switch(r){case"w":{(s=this.proxySocket.controlUser)==null||s.setCurrentAnimation(S.Character.Player.Back);break}case"s":{(i=this.proxySocket.controlUser)==null||i.setCurrentAnimation(S.Character.Player.Front);break}case"a":{(o=this.proxySocket.controlUser)==null||o.setCurrentAnimation(S.Character.Player.Left);break}case"d":{(a=this.proxySocket.controlUser)==null||a.setCurrentAnimation(S.Character.Player.Right);break}}}this.proxySocket.controlUser&&!this.joystick.w&&!this.joystick.s&&!this.joystick.a&&!this.joystick.d&&(this.proxySocket.controlUser.state=D.Hold,this.proxySocket.controlUser.currentAnimationIndex=1,this.proxySocket.controlUser.frame=1,this.proxySocket.controlUser.frameDir=!0),t===" "&&(this.joystick.space=!1),t==="z"&&(this.joystick.z=!1)}clearKey(){this.joystick.w=!1,this.joystick.s=!1,this.joystick.a=!1,this.joystick.d=!1}}class Bs extends Zt{constructor(t,s){const i=at({str:15,dex:5,int:5,luck:5});super(t,s);n(this,"messages",[]);n(this,"currentMessageIndex",0);n(this,"messageStatus","wait");n(this,"changeMessageTime",Math.floor(Math.random()*1e3)+1+300);this.setStat(i),this.initialHealthMana(Q.DEFAULT.NPC.HEALTH,Q.DEFAULT.NPC.MANA),this.setAroundDistance(50)}setMessages(t){this.messages=t,this.currentMessageIndex=Math.floor(Math.random()*this.messages.length)}addMessages(t){this.messages.push(t),this.currentMessageIndex=Math.floor(Math.random()*this.messages.length)}showNearSign(t,s,i,o){this.nearSign&&(t.textAlign="center",t.lineWidth=2,t.strokeStyle=f.Sign.White,t.fillStyle=f.Sign.Info,t.font=`bold ${32*d.SCALE}px sans-serif`,t.strokeText("?",this.position.x+s+x.UNIT.X/2,this.position.y+i-x.UNIT.Y/5-5*d.SCALE-10*o*d.SCALE),t.fillText("?",this.position.x+s+x.UNIT.X/2,this.position.y+i-x.UNIT.Y/5-5*d.SCALE-10*o*d.SCALE),t.lineWidth=1)}drawScale(t,s,i,o,a,r){t.fillStyle=f.Sign.Event,t.fillRect(s+(this.position.x+o-this.size.x/2)*r,i+(this.position.y+a-this.size.y/2)*r,this.size.x*r,this.size.y*r),t.font="bold 10px san-serif",t.textAlign="center",t.lineWidth=1,t.strokeStyle=f.Sign.White,t.strokeText(this.name,s+(this.position.x+o)*r,i+(this.position.y+a-this.size.y-20)*r),t.fillText(this.name,s+(this.position.x+o)*r,i+(this.position.y+a-this.size.y-20)*r)}draw(t,s,i,o){const[a,r]=rt(this.size),l=g.display.npc.name,y=g.display.npc.health,c=g.display.npc.mana;let p=Number(l)+Number(y)+Number(c);g.helper.npc.sign&&this.showNearSign(s,a,r,p),super.draw(t,s,i,o),l&&(p-=1,this.showName(s,a,r,p)),y&&(p-=1,this.showHealthBar(s,a,r,p)),c&&(p-=1,this.showManaBar(s,a,r,p)),this.showMessage(s,a,r,p)}showMessage(t,s,i,o){const r=this.messages[this.currentMessageIndex];if(this.messageStatus==="wait"){this.changeMessageTime-=1,this.changeMessageTime<0&&(this.changeMessageTime=500,this.messageStatus="talk");return}this.messageStatus==="talk"&&(this.changeMessageTime-=1,this.changeMessageTime<0&&(this.changeMessageTime=Math.floor(Math.random()*1e3)+1+300,this.messageStatus="wait",this.currentMessageIndex=Math.floor(Math.random()*this.messages.length))),r&&(t.fillStyle="#ffffff",t.fillRect(this.position.x+s+x.UNIT.X/2-r.length*1.6*10/2,this.position.y+i-x.UNIT.X/5-45*d.SCALE-10*o*d.SCALE,r.length*1.6*10,45),t.fillStyle="#000000",t.fillText(r,this.position.x+s+x.UNIT.X/2,this.position.y+i-x.UNIT.X/5-45*d.SCALE-10*o*d.SCALE+45/1.8))}showName(t,s,i,o){t.textAlign="center",t.fillStyle=f.Sign.Event,t.font=`bold ${12*d.SCALE}px sans-serif`;const l=g.display.npc.level?"Lv."+this.level+" "+this.name:this.name;t.lineWidth=2,t.strokeStyle=f.Sign.White,t.strokeText(l,this.position.x+s+x.UNIT.X/2,this.position.y+i-x.UNIT.X/5-5*d.SCALE-10*o*d.SCALE),t.fillText(l,this.position.x+s+x.UNIT.X/2,this.position.y+i-x.UNIT.X/5-5*d.SCALE-10*o*d.SCALE)}}class Yt extends Bs{constructor(t,s){super(t,s);n(this,"nearSign",!1);n(this,"unitTemp",null);n(this,"delayQueue",[]);n(this,"questionIndex",0);n(this,"questionList",[])}addQuestionFlows(t){t.forEach(({content:s,action:i})=>{this.questionList.push({q:s,action:i??(()=>{})})})}addQuestion(t,s){this.questionList.push({q:t,action:s??(()=>{})})}removeQuestionBox(){new K("question-exit").dispatch()}question(){new K("question").dispatch({name:this.name,profileImageUrl:this.profileImageUrl,question:this.questionList[this.questionIndex%this.questionList.length]})}nextQuestion(){const{action:t}=this.questionList[this.questionIndex%this.questionList.length];this.questionIndex+=1,this.removeQuestionBox(),U.splice(U.indexOf(this),1),!(U.length>0)&&(this.questionList.length>this.questionIndex?(U.push(this),this.question()):(t==null||t(),this.endQuestion()))}endQuestion(){this.setState(D.None),this.questionIndex=0,this.removeQuestionBox(),U.splice(U.indexOf(this),1)}showQuestionBoundaryHelper(t,s,i){const[o,a]=rt(this.size),r=this.dist+this.size.x,l=Math.abs(this.size.x-r),y=Math.abs(this.size.y-r),c=Math.sqrt(l**2+y**2);this.aroundUnit||this.nearSign?(t.strokeStyle=f.Sign.Near,t.fillStyle=f.Sign.Near+"56"):(t.strokeStyle=f.Sign.Dark+"56",t.fillStyle=f.Sign.None+"56"),t.beginPath(),t.arc(this.position.x+this.size.x/2+o,this.position.y+this.size.y/2+a,c-5,0,Math.PI*2),t.stroke(),t.fill()}draw(t,s,i,o){g.helper.npc.boundary.around&&this.showQuestionBoundaryHelper(t,i,o),super.draw(t,s,i,o)}}class wt extends Ct{constructor(t,s,i){super(t,s,i);n(this,"onceEvent")}addQuestionFlows(t){t.forEach(({content:s,action:i})=>{this.questionList.push({q:s,action:i??(()=>{})})})}addQuestion(t,s){this.questionList.push({q:t,action:s??(()=>{})})}removeQuestionBox(){new K("question-exit").dispatch()}question(){new K("question").dispatch({name:this.name,profileImageUrl:this.profileImageUrl,question:this.questionList[this.questionIndex%this.questionList.length]})}nextQuestion(){const{action:t}=this.questionList[this.questionIndex%this.questionList.length];this.questionIndex+=1,this.removeQuestionBox(),U.splice(U.indexOf(this),1),!(U.length>0)&&(this.questionList.length>this.questionIndex?(U.push(this),this.question()):(t==null||t(),this.endQuestion()))}endQuestion(){this.setState(D.None),this.questionIndex=0,this.removeQuestionBox(),U.splice(U.indexOf(this),1)}}class se{constructor(){n(this,"logger");n(this,"currentAgent","init");n(this,"proxyJoystick");n(this,"minimapOptions",{display:!0,scale:.5});n(this,"delayQueue",[]);n(this,"minimapCanvas",document.createElement("canvas"));n(this,"minimapCtx",this.minimapCanvas.getContext("2d"));n(this,"mapCanvas",document.createElement("canvas"));n(this,"mapCtx",this.mapCanvas.getContext("2d"));n(this,"unitCanvas",document.createElement("canvas"));n(this,"unitCtx",this.unitCanvas.getContext("2d"));n(this,"coverCanvas",document.createElement("canvas"));n(this,"coverCtx",this.coverCanvas.getContext("2d"));n(this,"infoCanvas",document.createElement("canvas"));n(this,"infoCtx",this.infoCanvas.getContext("2d"));n(this,"buildings",new Map);n(this,"users",new Map);n(this,"npcs",new Map);n(this,"monsters",new Map);n(this,"shootingObjects",new Map);n(this,"dropItems",new Map);n(this,"spawnLocate");n(this,"defaultGameField");n(this,"gameField",new xe(L.NONE,[]));n(this,"portals",[]);n(this,"before",0);n(this,"controlUser",null);n(this,"proxySocket");n(this,"ui");this.logger=new nt(se.name),this.logger.fixed.loaded(),this.addRenderLayer()}setup(){this.handleResizeCanvas()}defaultSpawnLocate(e){this.spawnLocate=e,this.defaultGameField=Z.getMap(e)}setProxySocket(e){this.proxySocket=e}setGameField(e){this.gameField=e}setPortals(...e){this.logger.debug("포탈 추가:",e),this.portals.push(...e.map(t=>(t.setMapManager(this),Lt(t),t)))}setSpawnBy(e,t){this.setGameField(Z.getMap(t)),e.setDefaultSpawnLocate(t)}collisionUp(e){var J,G,_;const t=this.gameField.fields,s=x.FIELD,i=t[0].length*s,o=t.length*s,a=e.position.x+i/2-e.size.x/2,r=e.position.y+o/2-e.size.y/2,l=a,y=a+e.size.x/2,c=a+e.size.x,p=r-e.velocity.speed,u=Math.floor(l/s),w=Math.floor(y/s),k=Math.floor(c/s),E=Math.floor(p/s),z=(J=t==null?void 0:t[E])==null?void 0:J[u],X=(G=t==null?void 0:t[E])==null?void 0:G[w],F=(_=t==null?void 0:t[E])==null?void 0:_[k];return!e.fly&&((z==null?void 0:z.type)==="block"||(X==null?void 0:X.type)==="block"||(F==null?void 0:F.type)==="block")||p<0}collisionDown(e){var Y,R,P,B,v,W;const t=this.gameField.fields,s=x.FIELD,i=t[0].length*s,o=t.length*s,a=e.position.x+i/2-e.size.x/2,r=e.position.y+o/2-e.size.y/2,l=10,y=a,c=a+e.size.x/2,p=a+e.size.x,u=r+e.size.y+e.velocity.speed,w=r+e.size.y+l+e.velocity.speed,k=Math.floor(y/s),E=Math.floor(c/s),z=Math.floor(p/s),X=Math.floor(u/s),F=Math.floor(w/s),J=(Y=t==null?void 0:t[X])==null?void 0:Y[k],G=(R=t==null?void 0:t[X])==null?void 0:R[E],_=(P=t==null?void 0:t[X])==null?void 0:P[z],m=(B=t==null?void 0:t[F])==null?void 0:B[k],N=(v=t==null?void 0:t[F])==null?void 0:v[E],C=(W=t==null?void 0:t[F])==null?void 0:W[z];return!e.fly&&((m==null?void 0:m.name)==="water"||(N==null?void 0:N.name)==="water"||(C==null?void 0:C.name)==="water")||!e.fly&&((J==null?void 0:J.type)==="block"||(G==null?void 0:G.type)==="block"||(_==null?void 0:_.type)==="block")||u>t.length*s}collisionLeft(e){var v,W,M,A,et,st;const t=this.gameField.fields,s=x.FIELD,i=t[0].length*s,o=t.length*s,a=e.position.x+i/2-e.size.x/2,r=e.position.y+o/2-e.size.y/2,l=10,y=r,c=r+e.size.y/2,p=r+e.size.y,u=r+l,w=r+l+e.size.y/2,k=r+l+e.size.y,E=a-e.velocity.speed,z=Math.floor(y/s),X=Math.floor(c/s),F=Math.floor(p/s),J=Math.floor(u/s),G=Math.floor(w/s),_=Math.floor(k/s),m=Math.floor(E/s),N=(v=t==null?void 0:t[z])==null?void 0:v[m],C=(W=t==null?void 0:t[X])==null?void 0:W[m],Y=(M=t==null?void 0:t[F])==null?void 0:M[m],R=(A=t==null?void 0:t[J])==null?void 0:A[m],P=(et=t==null?void 0:t[G])==null?void 0:et[m],B=(st=t==null?void 0:t[_])==null?void 0:st[m];return!e.fly&&((R==null?void 0:R.name)==="water"||(P==null?void 0:P.name)==="water"||(B==null?void 0:B.name)==="water")||!e.fly&&((N==null?void 0:N.type)==="block"||(C==null?void 0:C.type)==="block"||(Y==null?void 0:Y.type)==="block")||E<0}collisionRight(e){var v,W,M,A,et,st;const t=this.gameField.fields,s=x.FIELD,i=t[0].length*s,o=t.length*s,a=e.position.x+i/2-e.size.x/2,r=e.position.y+o/2-e.size.y/2,l=10,y=r,c=r+e.size.y/2,p=r+e.size.y,u=r+l,w=r+l+e.size.y/2,k=r+l+e.size.y,E=a+e.size.x+e.velocity.speed,z=Math.floor(y/s),X=Math.floor(c/s),F=Math.floor(p/s),J=Math.floor(u/s),G=Math.floor(w/s),_=Math.floor(k/s),m=Math.floor(E/s),N=(v=t==null?void 0:t[z])==null?void 0:v[m],C=(W=t==null?void 0:t[X])==null?void 0:W[m],Y=(M=t==null?void 0:t[F])==null?void 0:M[m],R=(A=t==null?void 0:t[J])==null?void 0:A[m],P=(et=t==null?void 0:t[G])==null?void 0:et[m],B=(st=t==null?void 0:t[_])==null?void 0:st[m];return!e.fly&&((R==null?void 0:R.name)==="water"||(P==null?void 0:P.name)==="water"||(B==null?void 0:B.name)==="water")||!e.fly&&((N==null?void 0:N.type)==="block"||(C==null?void 0:C.type)==="block"||(Y==null?void 0:Y.type)==="block")||E>t[0].length*s}sendAddMonsterAt(e,t){e.setLocate(t),this.proxySocket.socket.send(JSON.stringify({type:"join/monster",id:e.id,name:e.name,locate:e.locate,mtype:e.constructor.name,x:e.position.x,y:e.position.y,health:e.health,mana:e.mana,maxHealth:e.maxHealth,maxMana:e.maxMana}))}addBuilding(e){this.buildings.set(e.id,e),e.setMapManager(this),Lt(e)}addMonster(e){this.logger.debug("몬스터 추가:",e.id,e),this.monsters.set(e.id,e),Lt(e)}addMonsterAt(e,t){this.logger.debug("몬스터 추가 맵 위치:",t),e.setLocate(t),this.addMonster(e)}addUnit(e){this.logger.debug("유닛 추가:",e.id),this.users.set(e.id,e),Lt(e)}addNpc(e){this.logger.debug("NPC 추가:",e.id,e),this.npcs.set(e.id,e),Lt(e)}addDropItem(e){this.logger.debug("드랍 아이템 추가:",e.id,e),this.dropItems.set(e.id,e)}deleteDropItem(e){const t=this.dropItems.delete(e);this.logger.log("삭제 됨",t)}deleteUnit(e){const t=this.users.get(e);this.users.delete(e)&&(this.logger.info(`삭제 유닛: ${e}`),this.controlUser.id===e&&this.controlUser.health<=0&&(this.controlUser=null,t.health=t.maxHealth,t.mana=t.maxMana,this.addUnit(t),this.setControlUser(t),t.position=tt(mt.INIT),t.locate=this.spawnLocate,t.syncGlobalPosition(),this.setGameField(this.defaultGameField)))}setControlUser(e){this.controlUser=e}outUnit(e){this.users.has(e)&&this.users.delete(e)}run(){this.logger.debug("필드 렌더링!"),requestAnimationFrame(this.render.bind(this))}setupQuality(e,t,s){e.imageSmoothingEnabled=t,e.imageSmoothingQuality=s}addRenderLayer(){this.mapCanvas.id="map-layer",this.unitCanvas.id="unit-layer",this.coverCanvas.id="cover-layer",this.infoCanvas.id="info-layer",this.minimapCanvas.id="minimap-layer",$.append(this.mapCanvas),$.append(this.unitCanvas),$.append(this.coverCanvas),$.append(this.infoCanvas),$.append(this.minimapCanvas),this.logger.debug("캔버스 추가!"),this.setupQuality(this.mapCtx,!0,"low"),this.setupQuality(this.coverCtx,!0,"low"),this.setupQuality(this.unitCtx,!0,"low"),this.setupQuality(this.infoCtx,!0,"low"),this.setupQuality(this.minimapCtx,!0,"low"),window.addEventListener("resize",this.handleResizeCanvas.bind(this))}detectCurrentAgent(){let e="pc";return navigator.userAgent.match(/iphone|android|mobile|ipad|macintosh/gi)&&(e="mobile"),this.logger.debug(e),this.currentAgent=e,e}handleResizeCanvas(){var s;this.logger.debug("캔버스 리사이즈!"),this.mapCanvas.width=document.body.clientWidth,this.mapCanvas.height=document.body.clientHeight,this.unitCanvas.width=document.body.clientWidth,this.unitCanvas.height=document.body.clientHeight,this.coverCanvas.width=document.body.clientWidth,this.coverCanvas.height=document.body.clientHeight,this.infoCanvas.width=document.body.clientWidth,this.infoCanvas.height=document.body.clientHeight,this.minimapCanvas.width=document.body.clientWidth,this.minimapCanvas.height=document.body.clientHeight;const e=this.currentAgent,t=this.detectCurrentAgent();(s=this.controlUser)==null||s.syncGlobalPosition(),t!==e&&new K("update-joystick").dispatch({agent:t})}render(e){requestAnimationFrame(this.render.bind(this)),e*=.001;const t=Math.floor(e);this.draw(t),this.minimapOptions.display&&this.drawMinimap(15,15,.2),this.before=t}drawMinimap(e,t,s=1){const i=this.gameField.fields,o=i[0].length*x.FIELD*.5,a=i.length*x.FIELD*.5;if(i.length===0)return;const r=[...this.npcs.values()].filter(u=>this.controlUser?u.locate===this.controlUser.locate&&u.health>0:u.locate===this.spawnLocate&&u.health>0),l=[...this.users.values()].filter(u=>this.controlUser?u.locate===this.controlUser.locate&&u.health>0:u.locate===this.spawnLocate&&u.health>0),y=this.portals.filter(u=>this.controlUser?u.locate===this.controlUser.locate:u.locate===this.spawnLocate),c=[...this.monsters.values()].filter(u=>this.controlUser?u.locate===this.controlUser.locate&&u.health>0:u.locate===this.spawnLocate&&u.health>0),p=[...this.buildings.values()].filter(u=>this.controlUser?u.locate===this.controlUser.locate:u.locate===this.spawnLocate);this.minimapCtx.clearRect(0,0,this.mapCanvas.width,this.mapCanvas.height),this.minimapCtx.fillStyle="white",this.minimapCtx.fillRect(e,t,i[0].length*x.FIELD*s,i.length*x.FIELD*s),i.flat(1).forEach(u=>{u.drawScale(this.minimapCtx,e,t,s)});for(const u of l)u.drawScale(this.minimapCtx,e,t,o,a,s);for(const u of c)u.drawScale(this.minimapCtx,e,t,o,a,s);for(const u of r)u.drawScale(this.minimapCtx,e,t,o,a,s);for(const u of y)u.drawScale(this.minimapCtx,e,t,o,a,s);for(const u of p)u.drawScale(this.minimapCtx,e,t,o,a,s)}draw(e){const t=this.gameField.fields;if(t.length===0)return;if(this.mapCtx.clearRect(0,0,this.mapCanvas.width,this.mapCanvas.height),this.unitCtx.clearRect(0,0,this.unitCanvas.width,this.unitCanvas.height),this.infoCtx.clearRect(0,0,this.infoCanvas.width,this.infoCanvas.height),this.coverCtx.clearRect(0,0,this.coverCanvas.width,this.coverCanvas.height),g.display.gametime){const c=me(new Date,"HH:mm:ss");this.infoCtx.textAlign="center",this.infoCtx.font="bold 16px san-serif",this.infoCtx.fillStyle=f.Sign.Dark,this.infoCtx.strokeStyle=f.Sign.White,this.infoCtx.lineWidth=2,this.infoCtx.strokeText("⏱️ "+c,this.infoCanvas.width/2,30),this.infoCtx.fillText("⏱️ "+c,this.infoCanvas.width/2,30)}this.before,t.flat(1).forEach(c=>{c.drawTileset(this.coverCtx,this.mapCtx,this,t[0].length,t.length)});const s=[...this.buildings.values()].filter(c=>this.controlUser?c.locate===this.controlUser.locate:c.locate===this.spawnLocate),i=[...this.npcs.values()].filter(c=>this.controlUser?c.locate===this.controlUser.locate&&c.health>0:c.locate===this.spawnLocate&&c.health>0),o=[...this.users.values()].filter(c=>this.controlUser?c.locate===this.controlUser.locate&&c.health>0:c.locate===this.spawnLocate&&c.health>0),a=this.portals.filter(c=>this.controlUser?c.locate===this.controlUser.locate:c.locate===this.spawnLocate),r=[...this.dropItems.values()].filter(c=>this.controlUser?c.locate===this.controlUser.locate:c.locate===this.spawnLocate);for(const c of s)if(c.drawAnimateTile(this.unitCtx,this.infoCtx,this,t[0].length,t.length,!1),this.controlUser&&this.controlUser.locate===c.locate){const p=c.around(this.controlUser),u=this.proxyJoystick.space&&U.length===0;p&&!H.includes("forward")&&c.forwardField&&c.forwardPosition&&u&&(this.proxyJoystick.w=!1,this.proxyJoystick.s=!1,this.proxyJoystick.a=!1,this.proxyJoystick.d=!1,this.controlUser.velocity.speed=0,this.logger.debug("space bar!"),c instanceof wt?U.includes(c)||(U.push(c),$.querySelectorAll(".question").forEach(w=>w.remove()),c.question(),this.logger.debug("대화 시작"),this.logger.debug("대화중")):c.forward())}for(const c of r)if(c.draw(this.unitCtx,this.infoCtx,t[0].length,t.length),this.controlUser){const p=this.controlUser;c.around(p)&&this.proxyJoystick.z&&!H.includes("take-item")&&(H.push("take-item"),this.controlUser.inventory.addItem(c),c.dropped===!1&&(this.deleteDropItem(c.id),p.equipment.opened&&this.ui.reloadEquipment(p),p.inventory.opened&&this.ui.reloadInventory(p)))}for(const c of i)if(c.draw(this.unitCtx,this.infoCtx,t[0].length,t.length),this.controlUser&&this.controlUser.locate===c.locate){const p=c.aroundPlayer(this.controlUser),u=this.proxyJoystick.space&&U.length===0;p&&u&&(this.proxyJoystick.w=!1,this.proxyJoystick.s=!1,this.proxyJoystick.a=!1,this.proxyJoystick.d=!1,this.controlUser.velocity.speed=0,this.logger.debug("space bar!"),c instanceof Yt&&(U.includes(c)||(U.push(c),$.querySelectorAll(".question").forEach(w=>w.remove()),c.question(),this.logger.debug("대화 시작"),this.logger.debug("대화중"))))}for(const c of a)if(c.draw(this.unitCtx,this.infoCtx),this.controlUser&&this.controlUser.locate===c.locate){const p=c.around(this.controlUser),u=this.proxyJoystick.space&&U.length===0;p&&!H.includes("forward")&&u&&(this.proxyJoystick.w=!1,this.proxyJoystick.s=!1,this.proxyJoystick.a=!1,this.proxyJoystick.d=!1,this.controlUser.velocity.speed=0,c instanceof wt?U.includes(c)||(U.push(c),$.querySelectorAll(".question").forEach(w=>w.remove()),c.question(),this.logger.debug("대화 시작"),this.logger.debug("대화중")):c.forward())}for(const c of o)c.draw(this.unitCtx,this.infoCtx,t[0].length,t.length);const l=[...this.monsters.values()].filter(c=>this.controlUser?c.locate===this.controlUser.locate&&c.health>0:c.locate===this.spawnLocate&&c.health>0),y=[...this.shootingObjects.values()].filter(c=>this.controlUser?c.locate===this.controlUser.locate:c.locate===this.spawnLocate);for(const c of l)c.draw(this.unitCtx,this.infoCtx,t[0].length,t.length),this.controlUser&&(c.aroundAttackablePlayer(this.controlUser),c instanceof te?c.aroundAttack(this.controlUser,this.proxySocket.socket,this):c.aroundAttack(this.controlUser,this.proxySocket.socket),c.nearFollowSign&&(c.tracing(this.controlUser,this),g.mode==="multi"&&this.proxySocket.socket.send(JSON.stringify({type:"move/monster",id:c.id,x:c.position.x,y:c.position.y}))));for(const c of y){c.draw(this.unitCtx,this.infoCtx,t[0].length,t.length),c.move(),this.controlUser&&(c.parent instanceof dt?(c.aroundAttackablePlayer(this.controlUser),c.aroundAttack(this.controlUser,this.proxySocket.socket)):c.parent instanceof xt&&l.forEach(k=>{c.aroundAttackablePlayer(k),c.aroundAttack(k,this.proxySocket.socket)}));const p=Math.abs(c.startPosition.x-c.position.x),u=Math.abs(c.startPosition.y-c.position.y);Math.sqrt(p**2+u**2)>=c.offDist&&this.shootingObjects.delete(c.id)}for(const c of s)c.drawCurrentImage(this.unitCtx,!0),this.controlUser&&c.detectHideUnit(this.controlUser);if(this.controlUser){const c=this.controlUser.velocity.increase,p=this.controlUser.velocity.speed<this.controlUser.velocity.maxSpeed?this.controlUser.velocity.speed=parseFloat((this.controlUser.velocity.speed+c).toFixed(2)):this.controlUser.velocity.speed;(this.proxyJoystick.w||this.proxyJoystick.s||this.proxyJoystick.a||this.proxyJoystick.d)&&g.mode==="multi"&&this.proxySocket.socket.readyState===WebSocket.OPEN&&this.proxySocket.socket.send(JSON.stringify({type:"move",id:this.proxySocket.controlUser.id,x:this.proxySocket.controlUser.position.x,y:this.proxySocket.controlUser.position.y})),this.proxyJoystick.w&&(this.collisionUp(this.controlUser)||this.controlUser.move(0,-p)),this.proxyJoystick.s&&(this.collisionDown(this.controlUser)||this.controlUser.move(0,p)),this.proxyJoystick.a&&(this.collisionLeft(this.controlUser)||this.controlUser.move(-p,0)),this.proxyJoystick.d&&(this.collisionRight(this.controlUser)||this.controlUser.move(p,0)),Object.values(this.proxyJoystick).every(u=>u===!1)&&(this.controlUser.velocity.speed=0),this.controlUser.health<=0&&H.includes("control unit die")&&(H.splice(H.indexOf("control unit die"),1),this.deleteUnit(this.controlUser.id)),g.display.money&&(this.infoCtx.textAlign="center",this.infoCtx.font="bold 16px sans-serif",this.infoCtx.strokeStyle=f.Sign.White,this.infoCtx.fillStyle=f.Sign.Dark,this.infoCtx.lineWidth=2,this.infoCtx.strokeText("💰 "+this.controlUser.money,innerWidth/2,50),this.infoCtx.fillText("💰 "+this.controlUser.money,innerWidth/2,50)),this.controlUser.syncGlobalPosition(),this.controlUser.aroundAttackableMonster(l),this.controlUser.around(o)}}}class ie{constructor(){n(this,"logger");n(this,"elements",new Map);n(this,"currentStoryBook");n(this,"inventoryPlacement",{x:innerWidth*.7,y:innerHeight*.1});n(this,"equipmentPlacement",{x:innerWidth*.1,y:innerHeight*.1});this.logger=new nt(ie.name),this.logger.fixed.loaded(),new K("exp-update").subscribe(this.updateExp.bind(this)),new K("question").subscribe(this.question.bind(this)),new K("question-exit").subscribe(this.removeQuestionBox.bind(this))}showVersion(e){const t=this.element("div",{value:e,classNames:["version"]});$.append(t)}setupMobileJoystick(e){const t=document.createElement("div");t.id="mobile-joystick",e&&t.classList.add("activate");const s=document.createElement("div");s.id="ball";const i=document.createElement("div");i.classList.add("wrap"),i.append(s),t.append(i),$.append(t);const o=document.createElement("div");o.id="action-btn";const a=document.createElement("div");a.id="equip-btn";const r=document.createElement("div");r.id="inven-btn";const l=document.createElement("div");l.id="mobile-btns",l.append(o,a,r),$.append(l)}removeMobileJoystick(){document.querySelectorAll("#mobile-joystick").forEach(e=>e.remove())}removeQuestionBox(){document.querySelectorAll(".question").forEach(e=>e.remove())}question({name:e,question:t,profileImageUrl:s}){const i=this.element("div",{classNames:["question","portal-question"]}),o=this.element("div",{classNames:["profile"],styles:{"--profile":`url(${s})`},dataSet:[{key:"name",value:e}]}),a=this.element("div",{classNames:["question-content"]}),r=this.element("div",{classNames:["content"],value:t.q}),l=this.button({classNames:["question-confirm"],value:"확인"}),y=this.button({classNames:["question-exit"],value:"닫기"}),c=this.group("div",{classNames:["button-group"]},l,y);a.append(r,c),i.append(o,a),$.append(i)}updateExp({unit:e,percentage:t,maxExp:s,exp:i}){if(!$.querySelector("#exp-bar")){const o=document.createElement("div");o.id="exp-bar",$.append(o)}$.querySelector("#exp-bar").innerHTML=`
      <span class="bar" style="--procss: ${t}%"></span>
      <span class="text">${t}% (${i}/${s})</span>
    `,e.equipment.opened&&this.openEquipment(e)}openEquipment(e){this.closeEquipment(e);const t=`top: ${this.equipmentPlacement.y}px; left: ${this.equipmentPlacement.x}px;`,s=e.openEquipment(),i=this.element("div",{classNames:["equipment"],draggable:!0});i.style.cssText=t;const o=this.element("div",{classNames:["equipment-title"]}),a=this.element("div",{value:"Equipment"});o.append(a);const r=this.element("div",{classNames:["equipment-body-row"]}),l=e.equipment.getTotalByStatType("dex"),y=e.equipment.getTotalByStatType("int"),c=e.equipment.getTotalByStatType("luck"),p=B=>`<span><button class="stat-point" data-type="${B}">+</button></span>`,u=e.calculateUnitDamage(),w=e.equipment.getTotalByStatType("str"),k=this.element("div",{classNames:["character-stats"]});k.innerHTML=`
      <div>
        <span>str</span>
        <span>${u+w} (${u}${w>0?"+"+w:""})</span>
        ${e.statPoint>0?p("str"):""}
      </div>
      <div>
        <span>dex</span>
        <span>${e.stat.dex+l} (${e.stat.dex}${l>0?"+"+l:""})</span>
        ${e.statPoint>0?p("dex"):""}
      </div>
      <div>
        <span>int</span>
        <span>${e.stat.int+y} (${e.stat.int}${y>0?"+"+y:""})</span>
        ${e.statPoint>0?p("int"):""}
        </div>
      <div>
        <span>luck</span>
        <span>${e.stat.luck+c} (${e.stat.luck}${c>0?"+"+c:""})</span>
        ${e.statPoint>0?p("luck"):""}
      </div>
      ${e.statPoint>0?""+e.statPoint+`point${e.statPoint>1?"s":""}`:""}
      <hr />
      <div>
        <span>사정거리</span>
        <span>${e.attackDist}</span>
      </div>
      <div>
        <span>공격속도</span>
        <span>${e.velocity.attack}</span>
      </div>
      <div>
        <span>이동속도</span>
        <span>${e.velocity.maxSpeed}</span>
      </div>
    `;const E=this.element("div",{classNames:["equipment-body"]}),z=this.element("div",{classNames:["equipment-row"]}),X=this.element("div",{classNames:["row-head"],dataSet:[{key:"itemPosition",value:"head"},{key:"itemId",value:s.head.id}],styles:{"--view":`url(${s.head.getCurrentAnimationSrc()})`},value:s.head.currentAnimation?"":s.head.name});z.append(X);const F=this.element("div",{classNames:["equipment-row"]}),J=this.element("div",{classNames:["row-top"],dataSet:[{key:"itemPosition",value:"top"},{key:"itemId",value:s.top.id}],styles:{"--view":`url(${s.top.getCurrentAnimationSrc()})`},value:s.top.currentAnimation?"":s.top.name}),G=this.element("div",{classNames:["row-hand"],dataSet:[{key:"itemPosition",value:"hand"},{key:"itemId",value:s.hand.id}],styles:{"--view":`url(${s.hand.getCurrentAnimationSrc()})`},value:s.hand.currentAnimation?"":s.hand.name}),_=this.element("div",{classNames:["row-ring"],dataSet:[{key:"itemPosition",value:"ring"},{key:"itemId",value:s.ring.id}],styles:{"--view":`url(${s.ring.getCurrentAnimationSrc()})`},value:s.ring.currentAnimation?"":s.ring.name});F.append(G,J,_);const m=this.element("div",{classNames:["equipment-row"]}),N=this.element("div",{classNames:["row-weapon"],dataSet:[{key:"itemPosition",value:"weapon"},{key:"itemId",value:s.weapon.id}],styles:{"--view":`url(${s.weapon.getCurrentAnimationSrc()})`},value:s.weapon.currentAnimation?"":s.weapon.name}),C=this.element("div",{classNames:["row-guard"],dataSet:[{key:"itemPosition",value:"guard"},{key:"itemId",value:s.guard.id}],styles:{"--view":`url(${s.guard.getCurrentAnimationSrc()})`},value:s.guard.currentAnimation?"":s.guard.name}),Y=this.element("div",{classNames:["row-bottom"],dataSet:[{key:"itemPosition",value:"bottom"},{key:"itemId",value:s.bottom.id}],styles:{"--view":`url(${s.bottom.getCurrentAnimationSrc()})`},value:s.bottom.currentAnimation?"":s.bottom.name});m.append(N,Y,C);const R=this.element("div",{classNames:["equipment-row"]}),P=this.element("div",{classNames:["row-foot"],dataSet:[{key:"itemPosition",value:"foot"},{key:"itemId",value:s.foot.id}],styles:{"--view":`url(${s.foot.getCurrentAnimationSrc()})`},value:s.foot.currentAnimation?"":s.foot.name});R.append(P),E.append(z,F,m,R),r.append(E),r.append(k),i.append(o,r),$.append(i)}closeEquipment(e){e.closeEquipment(),document.querySelectorAll(".equipment").forEach(t=>t.remove())}reloadEquipment(e){this.closeEquipment(e),this.openEquipment(e)}reloadInventory(e){e.inventory.sorting(),this.closeInventory(e),this.openInventory(e)}openInventory(e){const t=`top: ${this.inventoryPlacement.y}px; left: ${this.inventoryPlacement.x}px;`,s=e.openInventory(),i=this.element("div",{classNames:["inventory"],draggable:!0});i.style.cssText=t;const o=this.element("div",{classNames:["inventory-title"]}),a=this.element("div",{classNames:["inventory-body"]}),r=this.element("table",{classNames:["inventory-table"]});a.append(r);const l=this.element("div",{value:"Inventory",colSpan:e.inventory.bagSize.x-1}),y=this.button({value:"✕",classNames:["inventory-exit"]});o.append(l,y),s.bags.forEach((p,u)=>{const w=this.element("tr",{classNames:["item-row"]});p.forEach((k,E)=>{const z=this.element("td",{value:k.currentAnimation?"":k.name,dataSet:[{key:"itemId",value:k.id}],classNames:["item-cell"],styles:{"--view":`url(${k.getCurrentAnimationSrc()})`}});w.append(z)}),r.append(w)});const c=this.element("div",{value:"💰 "+e.money,classNames:["inventory-money"]});a.append(c),i.append(o,a),$.append(i)}closeInventory(e){e.closeInventory(),document.querySelectorAll(".inventory").forEach(t=>t.remove())}startStory(e){return this.currentStoryBook=e,new Promise(t=>{const s=e.read();this.storyTelling(s),e.setWatcher(t)})}storyTelling(e){this.clearStory();const{subtitle:t,text:s,image:i}=e.story.read(),o=document.createElement("div");o.id="story",o.innerHTML=`
    <div class="cover"${i?` style="--cover: ${i}"`:""}>
      <div class="title">${e.title}</div>
      <div class="subtitle">${t}</div>
      <div class="contents">
        <div class="text">
        ${s}
        </div>
        <div class="btn-group">
          <button class="story-all-skip">모두 스킵</button>
          <button class="story-next" data-state="${this.currentStoryBook.state}">${e.replay?"종료":"다음"}</button>
        </div>
        <div class="page">${e.page}/${e.total}</div>
      </div>
    </div>
    `,$.append(o)}clearStory(){document.querySelectorAll("#story").forEach(e=>e.remove())}nextStory(){this.clearStory();const e=this.currentStoryBook.read();this.storyTelling(e)}skipStory(){this.clearStory(),this.currentStoryBook.init(),this.currentStoryBook.destory()}login(){const e=this.button({value:"Login",dataSet:{key:"type",value:"login"}}),t=this.button({value:"Guest",dataSet:{key:"type",value:"guest"}}),s=this.group("div",{classNames:["button-group"]},t,e),i=this.group("div",{classNames:["popup-center","bg-white"]},s);i.append(s),$.append(i),this.elements.set("login",i)}element(e="div",t={}){const{id:s,classNames:i,value:o,styles:a,dataSet:r,onClick:l,...y}=t,c=document.createElement(e);return s&&(c.id=s),i&&(c.className=i.join(" ")),o&&(c.innerText=o.trim()),r&&(Array.isArray(r)?r.forEach(p=>{c.dataset[p.key]=p.value}):c.dataset[r.key]=r.value),a&&Object.entries(a).forEach(([p,u])=>{c.style.setProperty(p,u)}),l&&(c.onclick=l),y&&Object.entries(y).forEach(([p,u])=>{Object.assign(c,{[p]:u})}),c}group(e,t={},...s){const i=this.element(e,t);return i.append(...s),i}button(e={}){return this.element("button",e)}}class qs extends Ct{constructor(t,s,i){super(t,s,i);n(this,"opacity",1);n(this,"opacityImage");this.setState(D.Hold),this.setCurrentAnimation(S.Building.Basic),this.setSize(158,224),this.setImageScale(1.1),this.setAroundDistance(Q.DEFAULT.BUILDING.AROUND_DIST),this.getOpacityImage()}getOpacityImage(){this.opacityImage=S.Building.Opacity}detectHideUnit(t){const s=this.dist+this.size.x,i=this.position.x,o=this.position.y,a=i-this.size.x/2<=t.position.x&&t.position.x<=i+this.size.x/2,r=o-s/2-x.UNIT.Y<=t.position.y&&t.position.y<=o;a&&r?this.opacity=.5:this.opacity=1}drawCurrentImage(t,s){const i=this.size.x,o=this.size.y,[a,r]=rt(this.size),l=this.opacity!==1;s?t.drawImage(l?this.opacityImage:this.currentAnimation,i*1.5,o*0,i,o/2,this.position.x+a-i/2*(this.imageScale-1)/2,this.position.y+r-x.UNIT.Y/2-o*(this.imageScale-1),i*this.imageScale,o/2*this.imageScale):t.drawImage(l?this.opacityImage:this.currentAnimation,i*1.5,o/2,i,o/2,this.position.x+a-i/2*(this.imageScale-1)/2,this.position.y+r+o*5.5*(this.imageScale-1)-x.UNIT.Y/2-o*(this.imageScale-1),i*this.imageScale,o/2*this.imageScale)}drawAnimateTile(t,s,i,o,a,r){const[l,y]=rt(this.size);g.helper.building.boundary.around&&this.showAroundBoudary(t,l,y),this.drawCurrentImage(t,r),g.display.building.name&&this.showDisplayName(t,l,y),g.helper.building.sign&&this.showSignHelper(s,l,y)}drawScale(t,s,i,o,a,r){t.fillStyle=f.Sign.House,t.fillRect(s+(this.position.x+o-this.size.x/2.5)*r,i+(this.position.y+a-this.size.y/5)*r,this.size.x/1.8*r*1.5,this.size.y/4.5*r*1.5),t.font="bold 10px san-serif",t.textAlign="center",t.lineWidth=1,t.strokeStyle=f.Sign.White,t.strokeText(this.name,s+(this.position.x+o)*r,i+(this.position.y+a-this.size.y/3)*r),t.fillText(this.name,s+(this.position.x+o)*r,i+(this.position.y+a-this.size.y/3)*r)}around(t){const s=this.dist+this.size.x,i=Math.abs(this.position.x-t.position.x),o=Math.abs(this.position.y-t.position.y),a=Math.sqrt(i**2+o**2);return this.opacity===.5?(this.nearSign=!1,this.nearSign):(a+this.size.x<s?(this.nearSign=!0,this.unitTemp===null&&(this.unitTemp=t)):(this.nearSign=!1,this.unitTemp=null),this.nearSign)}showDisplayName(t,s,i){t.font=`bold ${12*d.SCALE}px san-serif`,t.textAlign="center",t.strokeStyle=f.Sign.White,t.lineWidth=2,t.fillStyle=this.nameColor,t.strokeText(this.name.toUpperCase(),this.position.x+s+this.size.x/2,this.position.y+i-this.size.y/5),t.fillText(this.name.toUpperCase(),this.position.x+s+this.size.x/2,this.position.y+i-this.size.y/5)}showAroundBoudary(t,s,i){const o=this.dist+this.size.x;this.nearSign?(t.strokeStyle=f.Sign.Near,t.fillStyle=f.Sign.Near+"56"):(t.strokeStyle=f.Sign.Dark+"56",t.fillStyle=f.Sign.None+"56"),t.beginPath(),t.arc(this.position.x+this.size.x/2+s,this.position.y+this.size.y/2+i,o-this.size.x,0,Math.PI*2),t.stroke(),t.fill()}showSignHelper(t,s,i){this.nearSign&&(t.textAlign="center",t.lineWidth=2,t.strokeStyle=f.Sign.White,t.fillStyle=f.Sign.Info,t.font=`bold ${32*d.SCALE}px sans-serif`,t.strokeText("?",this.position.x+s+this.size.x/2,this.position.y+i-this.size.y+this.size.y*this.imageScale/2),t.fillText("?",this.position.x+s+this.size.x/2,this.position.y+i-this.size.y+this.size.y*this.imageScale/2),t.lineWidth=1)}}const Wt=new qs("빈 집",L.BASE_FIELD_1);Wt.setPositionByIndex(5,1);Wt.setForwardField(Z.getMap(L.HOUSE));Wt.setForwardPosition(tt(ft(0,4)));const Os={Basic:`${gt}profiles/building/basic.png`};class Rs extends wt{constructor(t,s,i){super(t,s,i);n(this,"opacity",1);n(this,"opacityImage");this.setState(D.Hold),this.setCurrentAnimation(S.Building.Basic),this.setSize(158,224),this.setImageScale(1.1),this.setAroundDistance(Q.DEFAULT.BUILDING.AROUND_DIST),this.setProfileImage(Os.Basic),this.getOpacityImage()}getOpacityImage(){this.opacityImage=S.Building.Opacity}detectHideUnit(t){const s=this.dist+this.size.x,i=this.position.x,o=this.position.y,a=i-this.size.x/2<=t.position.x&&t.position.x<=i+this.size.x/2,r=o-s/2-x.UNIT.Y<=t.position.y&&t.position.y<=o;a&&r?this.opacity=.5:this.opacity=1}drawCurrentImage(t,s){const i=this.size.x,o=this.size.y,[a,r]=rt(this.size),l=this.opacity!==1;s?t.drawImage(l?this.opacityImage:this.currentAnimation,i*1.5,o*0,i,o/2,this.position.x+a-i/2*(this.imageScale-1)/2,this.position.y+r-x.UNIT.Y/2-o*(this.imageScale-1),i*this.imageScale,o/2*this.imageScale):t.drawImage(l?this.opacityImage:this.currentAnimation,i*1.5,o/2,i,o/2,this.position.x+a-i/2*(this.imageScale-1)/2,this.position.y+r+o*5.5*(this.imageScale-1)-x.UNIT.Y/2-o*(this.imageScale-1),i*this.imageScale,o/2*this.imageScale)}drawAnimateTile(t,s,i,o,a,r){const[l,y]=rt(this.size);g.helper.building.boundary.around&&this.showAroundBoudary(t,l,y),this.drawCurrentImage(t,r),g.display.building.name&&this.showDisplayName(t,l,y),g.helper.building.sign&&this.showSignHelper(s,l,y)}drawScale(t,s,i,o,a,r){t.fillStyle=f.Sign.House,t.fillRect(s+(this.position.x+o-this.size.x/2.5)*r,i+(this.position.y+a-this.size.y/5)*r,this.size.x/1.8*r*1.5,this.size.y/4.5*r*1.5),t.font="bold 10px san-serif",t.textAlign="center",t.lineWidth=1,t.strokeStyle=f.Sign.White,t.strokeText(this.name,s+(this.position.x+o)*r,i+(this.position.y+a-this.size.y/3)*r),t.fillText(this.name,s+(this.position.x+o)*r,i+(this.position.y+a-this.size.y/3)*r)}around(t){const s=this.dist+this.size.x,i=Math.abs(this.position.x-t.position.x),o=Math.abs(this.position.y-t.position.y),a=Math.sqrt(i**2+o**2);return this.opacity===.5?(this.nearSign=!1,this.nearSign):(a+this.size.x<s?(this.nearSign=!0,this.unitTemp===null&&(this.unitTemp=t)):(this.nearSign=!1,this.unitTemp=null),this.nearSign)}showDisplayName(t,s,i){t.font=`bold ${12*d.SCALE}px san-serif`,t.textAlign="center",t.strokeStyle=f.Sign.White,t.lineWidth=2,t.fillStyle=this.nameColor,t.strokeText(this.name.toUpperCase(),this.position.x+s+this.size.x/2,this.position.y+i-this.size.y/5),t.fillText(this.name.toUpperCase(),this.position.x+s+this.size.x/2,this.position.y+i-this.size.y/5)}showAroundBoudary(t,s,i){const o=this.dist+this.size.x;this.nearSign?(t.strokeStyle=f.Sign.Near,t.fillStyle=f.Sign.Near+"56"):(t.strokeStyle=f.Sign.Dark+"56",t.fillStyle=f.Sign.None+"56"),t.beginPath(),t.arc(this.position.x+this.size.x/2+s,this.position.y+this.size.y/2+i,o-this.size.x,0,Math.PI*2),t.stroke(),t.fill()}showSignHelper(t,s,i){this.nearSign&&(t.textAlign="center",t.lineWidth=2,t.strokeStyle=f.Sign.White,t.fillStyle=f.Sign.Info,t.font=`bold ${32*d.SCALE}px sans-serif`,t.strokeText("?",this.position.x+s+this.size.x/2,this.position.y+i-this.size.y+this.size.y*this.imageScale/2),t.fillText("?",this.position.x+s+this.size.x/2,this.position.y+i-this.size.y+this.size.y*this.imageScale/2),t.lineWidth=1)}}const Tt=new Rs("촌장네",L.BASE_COUNTRY);Tt.setPositionByIndex(3.5,2);Tt.addQuestionFlows([{content:"집이 잠겨있다. 촌장과 친해지면 들어갈 수 있을까...?",action:()=>{Tt.logger.debug("이동을 막습니다.")}}]);Tt.setForwardField(Z.getMap(L.MAIN_HOUSE));Tt.setForwardPosition(tt(ft(0,4)));const Et=new wt("폐허가 된 마을",L.BASE_COUNTRY);Et.setPositionByIndex(10.5,3.8);Et.setForwardField(Z.getMap(L.DESTROYED_COUNTRY));Et.setForwardPosition(tt(ft(-7.5,3)));Et.addQuestionFlows([{content:"폐허가 된 마을로 이동합니다.",action:()=>{Et.forward()}}]);const Mt=new wt("태초마을",L.DESTROYED_COUNTRY);Mt.setPositionByIndex(-7.5,3);Mt.setForwardField(Z.getMap(L.BASE_COUNTRY));Mt.setForwardPosition(tt(ft(10.5,3.8)));Mt.addQuestionFlows([{content:"태초마을로 이동합니다.",action:()=>{Mt.forward()}}]);function js(h,e){const t=new te("monkey",e);return h?t.setPositionByIndex(h.x,h.y):t.setPositionByIndex(1,1),t.level=3,t.stat.str=10,t.setMoveSpeed(.5,.01),t.setAttackDelay(3),t.setDropMoney(50),t.setDropExp(20),t.setImageScale(1.5),t.setCurrentAnimation(S.Character.Monster.MonkeyFront),t.setCurrentShootAnimation(S.Object.Item.Banana),t}const pt=new Yt("마을주민1");pt.level=999;pt.setProfileImage(Ht.Chonjang);pt.setPositionByIndex(5,5);pt.setLocate(L.BASE_COUNTRY);pt.setCurrentAnimation(S.Character.Player.Back);pt.addQuestionFlows([{content:"에고고고고 삭신이야..."},{content:"너도 내 나이가 되면 삭신이 쑤실거야...",action:()=>{pt.logger.log("대화 종료")}}]);pt.addMessages("에고고...");pt.addMessages("어디서 본 것 같은데...");const ut=new Yt("GM");ut.level=999;ut.setProfileImage(Ht.Gm);ut.setPositionByIndex(-1,-3);ut.setLocate(L.BASE_COUNTRY);ut.addQuestionFlows([{content:"안녕하세요. GM입니다. 기존 2D RPG에서 컬리전이 매끄럽지 못한 부분을 보완하고 싱글, 멀티 유형과 게스트, 회원 로그인을 준비 중입니다."},{content:"컬리전과 싱글, 멀티 유형, 게스트 로그인이 테스트 완료 되었고, 현재 회원 가입 및 캐릭터 생성과 플레이를 테스트 중입니다."},{content:'"I"키로 인벤토리, "E"키로 착용 장비를 볼 수 있습니다! 인벤에서 좌 클릭은 착용, 장비에서 좌 클릭은 아이템 해제입니다.'},{content:"우 클릭으로 아이템을 버릴 수 있습니다."},{content:'"Z"키로 주변의 아이템을 주울 수 있습니다.'},{content:"많은 관심 부탁드립니다 :)",action:()=>{ut.logger.log("대화 종료")}}]);ut.addMessages("계속해서 업데이트 중 입니다.");ut.addMessages("필요한게 있으면 말씀해주세요!");ut.addMessages("추석 잘 지내세요~");const yt=new Yt("마을주민2");yt.level=999;yt.setProfileImage(Ht.Namoo);yt.setPositionByIndex(-2,1);yt.setLocate(L.BASE_COUNTRY);yt.addQuestionFlows([{content:"아직 아무 컨텐츠가 없어요."},{content:"...",action:()=>{yt.logger.log("대화 종료")}}]);yt.addMessages("...");yt.addMessages("뭘봐");class Ie extends Ct{constructor(e,t,s){super(e,t,s)}}const Ut=new wt("마을 앞",L.BASE_COUNTRY);Ut.setPositionByIndex(-10.5,-2.2);Ut.setForwardField(Z.getMap(L.BASE_FIELD_1));Ut.setForwardPosition(tt(ft(9,3)));Ut.addQuestionFlows([{content:"마을 앞으로 이동합니다.",action:()=>{Ut.forward()}}]);const kt=new wt("태초마을",L.BASE_FIELD_1);kt.setPositionByIndex(9,3);kt.addQuestion("태초마을로 이동합니다.",()=>{});kt.addQuestion("이동하시겠습니까?",()=>{kt.forward()});kt.setForwardField(Z.getMap(L.BASE_COUNTRY));kt.setForwardPosition(tt(ft(-10.5,-2.2)));const $t=new Ie("마을 앞",L.HOUSE);$t.setPositionByIndex(0,4);$t.setForwardField(Z.getMap(L.BASE_FIELD_1));$t.setForwardPosition(tt(ft(4.7,2.5)));const Ft=new Ie("태초마을",L.MAIN_HOUSE);Ft.setPositionByIndex(0,4);Ft.setForwardField(Z.getMap(L.BASE_COUNTRY));Ft.setForwardPosition(tt(ft(3.2,3.5)));function Hs(){const h=new Ns,e=new Ps,t=new se,s=new ie;h.setup({eventManager:e,mapManager:t,ui:s}),h.setOption(g),h.defaultSpawnLocate(g.defaultSpawn),t.addNpc(ut),t.addNpc(pt),t.addNpc(yt),t.setPortals(Ut),t.setPortals(kt),t.setPortals(Ft),t.setPortals($t),t.setPortals(Et),t.setPortals(Mt),t.addBuilding(Tt),t.addBuilding(Wt),g.mode==="single"?(Ys(t),h.run(),h.eventManager.popupLogin()):h.socket.socketReady().then(()=>{h.eventManager.popupLogin()})}function Ys(h){const e=js({x:0,y:2}),t=It({x:-1,y:-2}),s=It({x:-5,y:3});s.level=2,h.addMonsterAt(e,L.BASE_FIELD_1),h.addMonsterAt(t,L.BASE_FIELD_1),h.addMonsterAt(s,L.BASE_FIELD_1)}Hs();
